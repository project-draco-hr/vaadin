{
  Map<Class<?>,CurrentInstance> old=new HashMap<Class<?>,CurrentInstance>();
  old.put(VaadinSession.class,new CurrentInstance(VaadinSession.getCurrent(),true));
  old.put(VaadinService.class,new CurrentInstance(VaadinService.getCurrent(),true));
  VaadinService service=null;
  if (session != null) {
    service=session.getService();
  }
  VaadinSession.setCurrent(session);
  VaadinService.setCurrent(service);
  if (service instanceof VaadinServletService) {
    old.put(VaadinServlet.class,new CurrentInstance(VaadinServlet.getCurrent(),true));
    VaadinServlet.setCurrent(((VaadinServletService)service).getServlet());
  }
 else   if (portletAvailable && service instanceof VaadinPortletService) {
    old.put(VaadinPortlet.class,new CurrentInstance(VaadinPortlet.getCurrent(),true));
    VaadinPortlet.setCurrent(((VaadinPortletService)service).getPortlet());
  }
  return old;
}
