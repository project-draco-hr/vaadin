{
  UI uI=session.getService().findUI(request);
  checkWidgetsetVersion(request);
  String requestThemeName=request.getParameter("theme");
  ClientConnector highlightedConnector;
  boolean repaintAll;
  final OutputStream out=response.getOutputStream();
  repaintAll=(request.getParameter(ApplicationConstants.URL_PARAMETER_REPAINT_ALL) != null);
  boolean analyzeLayouts=false;
  if (repaintAll) {
    analyzeLayouts=(request.getParameter(ApplicationConstants.PARAM_ANALYZE_LAYOUTS) != null);
    String pid=request.getParameter(ApplicationConstants.PARAM_HIGHLIGHT_CONNECTOR);
    if (pid != null) {
      highlightedConnector=uI.getConnectorTracker().getConnector(pid);
      highlightConnector(highlightedConnector);
    }
  }
  final Writer outWriter=new BufferedWriter(new OutputStreamWriter(out,"UTF-8"));
  session.lock();
  try {
    rpcHandler.handleRpc(uI,request.getReader(),request);
    if (repaintAll) {
      session.getCommunicationManager().repaintAll(uI);
    }
    writeUidl(request,response,uI,outWriter,repaintAll,analyzeLayouts);
    postHandleRequest(uI);
  }
 catch (  JSONException e) {
    getLogger().log(Level.SEVERE,"Error writing JSON to response",e);
    criticalNotifier.criticalNotification(request,response,null,null,null,null);
  }
catch (  InvalidUIDLSecurityKeyException e) {
    getLogger().log(Level.WARNING,"Invalid security key received from {}",request.getRemoteHost());
    criticalNotifier.criticalNotification(request,response,null,null,null,null);
  }
 finally {
    session.unlock();
    outWriter.close();
    requestThemeName=null;
  }
  response.setHeader("Cache-Control","no-cache");
  return true;
}
