{
  UI uI=session.getService().findUI(request);
  if (uI == null) {
    UIInitHandler.commitJsonResponse(request,response,getUINotFoundErrorJSON(session.getService(),request));
    return true;
  }
  checkWidgetsetVersion(request);
  boolean repaintAll;
  repaintAll=(request.getParameter(ApplicationConstants.URL_PARAMETER_REPAINT_ALL) != null);
  StringWriter stringWriter=new StringWriter();
  try {
    rpcHandler.handleRpc(uI,request.getReader(),request);
    if (repaintAll) {
      session.getCommunicationManager().repaintAll(uI);
    }
    writeUidl(request,response,uI,stringWriter,repaintAll);
  }
 catch (  JsonException e) {
    getLogger().log(Level.SEVERE,"Error writing JSON to response",e);
    writeRefresh(request,response);
    return true;
  }
catch (  InvalidUIDLSecurityKeyException e) {
    getLogger().log(Level.WARNING,"Invalid security key received from {0}",request.getRemoteHost());
    writeRefresh(request,response);
    return true;
  }
 finally {
    stringWriter.close();
  }
  return UIInitHandler.commitJsonResponse(request,response,stringWriter.toString());
}
