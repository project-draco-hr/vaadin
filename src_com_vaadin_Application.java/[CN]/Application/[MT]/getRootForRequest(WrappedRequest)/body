{
  Root root=Root.getCurrentRoot();
  if (root != null) {
    return root;
  }
  Integer rootId=getRootId(request);
synchronized (this) {
    PendingRootRequest pendingRootRequest=pendingRoots.remove(rootId);
    if (pendingRootRequest == null && rootId != null) {
      root=roots.get(rootId);
    }
 else {
      root=getRoot(request);
      if (root.getApplication() == null) {
        root.setApplication(this);
      }
      if (root.getRootId() < 0) {
        int id=(rootId != null ? rootId.intValue() : nextRootId++);
        root.setRootId(id);
        roots.put(Integer.valueOf(root.getRootId()),root);
        root.init(request);
      }
    }
  }
  Root.setCurrentRoot(root);
  return root;
}
