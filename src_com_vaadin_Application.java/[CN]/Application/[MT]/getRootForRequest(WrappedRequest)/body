{
  Root root=Root.getCurrentRoot();
  if (root != null) {
    return root;
  }
  Integer rootId=getRootId(request);
synchronized (this) {
    PendingRootRequest pendingRootRequest=pendingRoots.remove(rootId);
    root=roots.get(rootId);
    if (root == null) {
      root=getRoot(request);
      if (root.getApplication() == null) {
        root.setApplication(this);
      }
      if (root.getRootId() < 0) {
        int id=(rootId != null ? rootId.intValue() : nextRootId++);
        root.setRootId(id);
        roots.put(Integer.valueOf(root.getRootId()),root);
        if (pendingRootRequest == null && root.getClass().isAnnotationPresent(RootInitRequiresBrowserDetals.class)) {
          pendingRoots.put(Integer.valueOf(id),new PendingRootRequest(request));
        }
 else {
          root.init(request);
        }
      }
    }
 else     if (pendingRootRequest != null) {
      root.init(request);
    }
  }
  Root.setCurrentRoot(root);
  return root;
}
