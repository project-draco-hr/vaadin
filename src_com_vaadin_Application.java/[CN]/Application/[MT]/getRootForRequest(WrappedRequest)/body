{
  Root root=Root.getCurrentRoot();
  if (root != null) {
    return root;
  }
  Integer rootId=getRootId(request);
synchronized (this) {
    RootPreserveStrategy rootPreserveStrategy=getRootPreserveStrategy();
    BrowserDetails browserDetails=request.getBrowserDetails();
    if (browserDetails != null) {
      pendingRoots.remove(rootId);
    }
    root=roots.get(rootId);
    if (root == null && rootPreserveStrategy != null) {
      Integer retainedRootId=rootPreserveStrategy.getPreservedRootForRequest(request);
      if (retainedRootId != null) {
        rootId=retainedRootId;
        root=roots.get(rootId);
      }
    }
    if (root == null) {
      root=getRoot(request);
      if (root.getApplication() == null) {
        root.setApplication(this);
      }
      if (root.getRootId() < 0) {
        if (rootId == null) {
          rootId=Integer.valueOf(nextRootId++);
        }
        root.setRootId(rootId.intValue());
        roots.put(rootId,root);
      }
    }
    if (!initedRoots.contains(rootId)) {
      boolean initRequiresBrowserDetails=(rootPreserveStrategy != null && rootPreserveStrategy.reqsterRequiresBrowserDetails()) || root.getClass().isAnnotationPresent(RootInitRequiresBrowserDetals.class);
      if (initRequiresBrowserDetails && browserDetails == null) {
        pendingRoots.put(rootId,new PendingRootRequest(request));
      }
 else {
        if (rootPreserveStrategy != null) {
          rootPreserveStrategy.registerRoot(root,request);
        }
        root.doInit(request);
        initedRoots.add(rootId);
      }
    }
  }
  Root.setCurrentRoot(root);
  return root;
}
