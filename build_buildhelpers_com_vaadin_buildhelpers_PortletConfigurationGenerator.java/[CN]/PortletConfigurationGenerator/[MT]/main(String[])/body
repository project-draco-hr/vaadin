{
  if (args.length < 1 || !new File(args[0]).isDirectory()) {
    System.err.println("Usage: PortletConfigurationGenerator <directory> [widgetset]");
    return;
  }
  String widgetset="";
  if (args.length > 1) {
    widgetset=args[1];
  }
  File dir=new File(args[0]);
  File webxmlFile=new File(dir.getAbsolutePath() + File.separatorChar + WEB_XML_FILE);
  String webXml="";
  BufferedReader in=null;
  try {
    in=new BufferedReader(new FileReader(webxmlFile));
    String line=in.readLine();
    while (line != null) {
      webXml+=line;
      line=in.readLine();
    }
  }
 catch (  FileNotFoundException e1) {
    System.out.println(webxmlFile + " not found!");
    return;
  }
catch (  IOException e2) {
    System.out.println("IOException while reading " + webxmlFile);
    webXml=null;
  }
  try {
    if (in != null) {
      in.close();
    }
  }
 catch (  IOException e1) {
    System.out.println("IOException while closing " + webxmlFile);
  }
  if (webXml == null) {
    System.out.println("Could not read web.xml!");
    return;
  }
  File portletXmlFile=new File(args[0] + File.separatorChar + PORTLET_XML_FILE);
  OutputStreamWriter pout=null;
  try {
    pout=new OutputStreamWriter(new FileOutputStream(portletXmlFile),Charset.forName("UTF-8"));
  }
 catch (  FileNotFoundException e) {
    System.out.println(portletXmlFile + " not found!");
  }
  File liferayPortletXmlFile=new File(args[0] + File.separatorChar + LIFERAY_PORTLET_XML_FILE);
  OutputStreamWriter lpout=null;
  try {
    lpout=new OutputStreamWriter(new FileOutputStream(liferayPortletXmlFile),Charset.forName("UTF-8"));
  }
 catch (  FileNotFoundException e) {
    System.out.println(liferayPortletXmlFile + " not found!");
  }
  File liferayDisplayXmlFile=new File(args[0] + File.separatorChar + LIFERAY_DISPLAY_XML_FILE);
  OutputStreamWriter ldout=null;
  try {
    ldout=new OutputStreamWriter(new FileOutputStream(liferayDisplayXmlFile),Charset.forName("UTF-8"));
  }
 catch (  FileNotFoundException e) {
    System.out.println(liferayDisplayXmlFile + " not found!");
  }
  File jbossObjectXmlFile=new File(args[0] + File.separatorChar + JBOSS_OBJECT_FILE);
  OutputStreamWriter joout=null;
  try {
    joout=new OutputStreamWriter(new FileOutputStream(jbossObjectXmlFile),Charset.forName("UTF-8"));
  }
 catch (  FileNotFoundException e) {
    System.out.println(jbossObjectXmlFile + " not found!");
  }
  File jbossInstanceXmlFile=new File(args[0] + File.separatorChar + JBOSS_INSTANCE_FILE);
  OutputStreamWriter jiout=null;
  try {
    jiout=new OutputStreamWriter(new FileOutputStream(jbossInstanceXmlFile),Charset.forName("UTF-8"));
  }
 catch (  FileNotFoundException e) {
    System.out.println(jbossInstanceXmlFile + " not found!");
  }
  if (pout != null && lpout != null && ldout != null && joout != null && jiout != null) {
    String pstring=PORTLET_XML_HEAD;
    String lpstring=LIFERAY_PORTLET_XML_HEAD;
    String ldstring=LIFERAY_DISPLAY_XML_HEAD;
    String jostring=JBOSS_OBJECT_HEAD;
    String jistring=JBOSS_INSTANCE_HEAD;
    Pattern p1=Pattern.compile("<servlet-mapping>.*?<servlet-name>(.*?)<\\/servlet-name>.*?<url-pattern>(.*?)<\\/url-pattern>(.*?)<\\/servlet-mapping>");
    Pattern p2=Pattern.compile(".*?<!--\\s+portlet\\s?style=([^ ]*)?\\s+-->.*?");
    Pattern findWidgetset=Pattern.compile("<init-param>.*?<param-name>widgetset<\\/param-name>.*?<param-value>(.*?)<\\/param-value>");
    Matcher m=p1.matcher(webXml);
    while (m.find()) {
      if (m.groupCount() < 3) {
        continue;
      }
      String name=m.group(1);
      name=name.replaceAll("^\\s*","");
      name=name.replaceAll("\\s*$","");
      String comment=m.group(3);
      Matcher m2=p2.matcher(comment);
      if (!m2.find()) {
        continue;
      }
      String style="";
      if (m2.groupCount() == 1 && m2.group(1) != null && !m2.group(1).equals("")) {
        style="<init-param><name>style</name><value>" + m2.group(1) + "</value></init-param>";
      }
      Pattern findServlet=Pattern.compile("<servlet>.*?<servlet-name>" + name + "<\\/servlet-name>(.*?)<\\/servlet>");
      Matcher servletMatcher=findServlet.matcher(webXml);
      if (servletMatcher.find()) {
        String servletXml=servletMatcher.group(1);
        Matcher widgetsetMatcher=findWidgetset.matcher(servletXml);
        if (widgetsetMatcher.find()) {
          String definedWidgetSet=widgetsetMatcher.group(1);
          if (!definedWidgetSet.equals(widgetset)) {
            System.err.println("WARNING: Widgetset in web.xml (" + definedWidgetSet + ") does not match used ("+ widgetset+ ")");
          }
        }
      }
      if (widgetset != null && !widgetset.equals("")) {
        System.err.println("Using widgetset: " + widgetset);
        style+="\n                " + "<init-param><name>widgetset</name><value>" + widgetset + "</value></init-param>";
      }
      String pname=name + "Portlet";
      String url=m.group(2);
      url=url.replaceAll("^\\s*","");
      url=url.replaceAll("\\s*$","");
      if (url.startsWith("/")) {
        url=url.substring(1);
      }
      if (url.endsWith("*")) {
        url=url.substring(0,url.length() - 1);
      }
      if (url.endsWith("/")) {
        url=url.substring(0,url.length() - 1);
      }
      System.out.println("Mapping " + pname + " to "+ url);
      String s=PORTLET_XML_SECTION;
      s=s.replaceAll("%NAME%",name);
      s=s.replaceAll("%PORTLETNAME%",pname);
      s=s.replaceAll("%URL%",url);
      s=s.replaceAll("%EXTRAPARAMS%",style);
      pstring+=s;
      s=LIFERAY_PORTLET_XML_SECTION;
      s=s.replaceAll("%NAME%",name);
      s=s.replaceAll("%PORTLETNAME%",pname);
      s=s.replaceAll("%URL%",url);
      lpstring+=s;
      s=LIFERAY_DISPLAY_XML_SECTION;
      s=s.replaceAll("%NAME%",name);
      s=s.replaceAll("%PORTLETNAME%",pname);
      s=s.replaceAll("%URL%",url);
      ldstring+=s;
      s=JBOSS_OBJECT_SECTION;
      s=s.replaceAll("%NAME%",name);
      s=s.replaceAll("%PORTLETNAME%",pname);
      s=s.replaceAll("%URL%",url);
      jostring+=s;
      s=JBOSS_INSTANCE_SECTION;
      s=s.replaceAll("%NAME%",name);
      s=s.replaceAll("%PORTLETNAME%",pname);
      s=s.replaceAll("%URL%",url);
      jistring+=s;
    }
    pstring+=PORTLET_XML_FOOT;
    lpstring+=LIFERAY_PORTLET_XML_FOOT;
    ldstring+=LIFERAY_DISPLAY_XML_FOOT;
    jostring+=JBOSS_OBJECT_FOOT;
    jistring+=JBOSS_INSTANCE_FOOT;
    try {
      pout.write(pstring);
      lpout.write(lpstring);
      ldout.write(ldstring);
      joout.write(jostring);
      jiout.write(jistring);
    }
 catch (    IOException e) {
      System.out.println("Write FAILED:" + e);
    }
  }
  try {
    if (pout != null) {
      pout.close();
    }
    if (lpout != null) {
      lpout.close();
    }
    if (ldout != null) {
      ldout.close();
    }
    if (joout != null) {
      joout.close();
    }
    if (jiout != null) {
      jiout.close();
    }
  }
 catch (  IOException e) {
    System.out.println("Close FAILED: " + e);
  }
  System.out.println("Done.");
}
