{
  String f="";
  if (format != null && format.length() > 0) {
    String lastTokenType=null;
    String currentToken="";
    for (int i=0; i < format.length(); i++) {
      String thisChar=format.substring(i,i + 1);
      String currentTokenType=DateLocale.SUPPORTED_DF_TOKENS.contains(thisChar) ? thisChar : "";
      if (currentTokenType.equals(lastTokenType) || i == 0) {
        currentToken+=thisChar;
        lastTokenType=currentTokenType;
      }
 else {
        if ("".equals(lastTokenType)) {
          f+=currentToken;
        }
 else {
          f+=handleToken(currentToken,date);
        }
        currentToken=thisChar;
        lastTokenType=currentTokenType;
      }
    }
    if ("".equals(lastTokenType)) {
      f+=currentToken;
    }
 else {
      f+=handleToken(currentToken,date);
    }
  }
  return f;
}
