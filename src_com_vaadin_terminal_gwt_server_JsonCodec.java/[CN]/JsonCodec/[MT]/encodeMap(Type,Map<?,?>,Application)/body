{
  Type keyType, valueType;
  if (mapType instanceof ParameterizedType) {
    keyType=((ParameterizedType)mapType).getActualTypeArguments()[0];
    valueType=((ParameterizedType)mapType).getActualTypeArguments()[1];
  }
 else {
    throw new JSONException("Map is missing generics");
  }
  JSONObject jsonMap=new JSONObject();
  for (  Object mapKey : map.keySet()) {
    Object mapValue=map.get(mapKey);
    Object encodedKey=encode(mapKey,null,keyType,application);
    Object encodedValue=encode(mapValue,null,valueType,application);
    jsonMap.put(JSONObject.quote(encodedKey.toString()),encodedValue);
  }
  return jsonMap;
}
