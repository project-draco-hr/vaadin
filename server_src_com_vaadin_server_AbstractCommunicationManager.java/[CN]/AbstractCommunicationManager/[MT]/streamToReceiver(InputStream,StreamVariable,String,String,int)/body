{
  if (streamVariable == null) {
    throw new IllegalStateException("StreamVariable for the post not found");
  }
  final VaadinSession session=getVaadinSession();
  OutputStream out=null;
  int totalBytes=0;
  StreamingStartEventImpl startedEvent=new StreamingStartEventImpl(filename,type,contentLength);
  try {
    boolean listenProgress;
synchronized (session) {
      streamVariable.streamingStarted(startedEvent);
      out=streamVariable.getOutputStream();
      listenProgress=streamVariable.listenProgress();
    }
    if (out == null) {
      throw new NoOutputStreamException();
    }
    if (null == in) {
      throw new NoInputStreamException();
    }
    final byte buffer[]=new byte[MAX_UPLOAD_BUFFER_SIZE];
    int bytesReadToBuffer=0;
    while ((bytesReadToBuffer=in.read(buffer)) > 0) {
      out.write(buffer,0,bytesReadToBuffer);
      totalBytes+=bytesReadToBuffer;
      if (listenProgress) {
synchronized (session) {
          StreamingProgressEventImpl progressEvent=new StreamingProgressEventImpl(filename,type,contentLength,totalBytes);
          streamVariable.onProgress(progressEvent);
        }
      }
      if (streamVariable.isInterrupted()) {
        throw new UploadInterruptedException();
      }
    }
    out.close();
    StreamingEndEvent event=new StreamingEndEventImpl(filename,type,totalBytes);
synchronized (session) {
      streamVariable.streamingFinished(event);
    }
  }
 catch (  UploadInterruptedException e) {
    tryToCloseStream(out);
    StreamingErrorEvent event=new StreamingErrorEventImpl(filename,type,contentLength,totalBytes,e);
synchronized (session) {
      streamVariable.streamingFailed(event);
    }
  }
catch (  final Exception e) {
    tryToCloseStream(out);
synchronized (session) {
      StreamingErrorEvent event=new StreamingErrorEventImpl(filename,type,contentLength,totalBytes,e);
      streamVariable.streamingFailed(event);
      throw new UploadException(e);
    }
  }
  return startedEvent.isDisposed();
}
