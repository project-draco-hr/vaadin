{
  if (!isUploading) {
    throw new IllegalStateException("uploading not started");
  }
  final String filename=upload.getContentName();
  final String type=upload.getContentType();
  fireStarted(filename,type);
  final OutputStream out=receiver.receiveUpload(filename,type);
  if (out == null) {
    throw new RuntimeException("Error getting outputstream from upload receiver");
  }
  final InputStream in=upload.getStream();
  if (null == in) {
    fireUploadInterrupted(filename,type,0);
    endUpload();
    return;
  }
  final byte buffer[]=new byte[BUFFER_SIZE];
  int bytesRead=0;
  totalBytes=0;
  try {
    while ((bytesRead=in.read(buffer)) > 0) {
      out.write(buffer,0,bytesRead);
      totalBytes+=bytesRead;
      if (progressListener != null && contentLength > 0) {
        progressListener.updateProgress(totalBytes,contentLength);
      }
    }
    out.close();
    fireUploadSuccess(filename,type,totalBytes);
    endUpload();
    requestRepaint();
  }
 catch (  final IOException e) {
    fireUploadInterrupted(filename,type,totalBytes);
    endUpload();
  }
}
