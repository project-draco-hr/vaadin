{
  if (!isUploading)   throw new IllegalStateException("uploading not started");
  String filename=upload.getContentName();
  String type=upload.getContentType();
  fireStarted(filename,type);
  OutputStream out=receiver.receiveUpload(filename,type);
  if (out == null)   throw new RuntimeException("Error getting outputstream from upload receiver");
  InputStream in=upload.getStream();
  if (null == in) {
    fireUploadInterrupted(filename,type,0);
    endUpload();
    return;
  }
  byte buffer[]=new byte[BUFFER_SIZE];
  int bytesRead=0;
  totalBytes=0;
  try {
    while ((bytesRead=in.read(buffer)) > 0) {
      out.write(buffer,0,bytesRead);
      totalBytes+=bytesRead;
      if (progressListener != null && contentLength > 0) {
        progressListener.updateProgress(totalBytes,contentLength);
      }
    }
    out.close();
    fireUploadSuccess(filename,type,totalBytes);
    endUpload();
    requestRepaint();
  }
 catch (  IOException e) {
    fireUploadInterrupted(filename,type,totalBytes);
    endUpload();
  }
}
