{
  Collection<Class<?>> deferredWidgets=new LinkedList<Class<?>>();
  sourceWriter.println("public void ensureInstantiator(Class<? extends " + componentConnectorClassName + "> classType) {");
  sourceWriter.println("if(!instmap.containsKey(classType)){");
  boolean first=true;
  ArrayList<Class<? extends ComponentConnector>> lazyLoadedWidgets=new ArrayList<Class<? extends ComponentConnector>>();
  HashSet<Class<? extends com.vaadin.terminal.gwt.client.ComponentConnector>> connectorsWithInstantiator=new HashSet<Class<? extends com.vaadin.terminal.gwt.client.ComponentConnector>>();
  for (  Class<? extends ComponentConnector> class1 : connectorsHavingComponentAnnotation) {
    Class<? extends ComponentConnector> clientClass=class1;
    if (connectorsWithInstantiator.contains(clientClass)) {
      continue;
    }
    if (clientClass == RootConnector.class) {
      continue;
    }
    if (!first) {
      sourceWriter.print(" else ");
    }
 else {
      first=false;
    }
    sourceWriter.print("if( classType == " + clientClass.getName() + ".class) {");
    String instantiator="new WidgetInstantiator() {\n public " + componentConnectorClassName + " get() {\n return GWT.create("+ clientClass.getName()+ ".class );\n}\n}\n";
    LoadStyle loadStyle=getLoadStyle(class1);
    if (loadStyle != LoadStyle.EAGER) {
      sourceWriter.print("ApplicationConfiguration.startWidgetLoading();\n" + "GWT.runAsync( \n" + "new WidgetLoader() { void addInstantiator() {instmap.put(" + clientClass.getName() + ".class,"+ instantiator+ ");}});\n");
      lazyLoadedWidgets.add(class1);
      if (loadStyle == LoadStyle.DEFERRED) {
        deferredWidgets.add(class1);
      }
    }
 else {
      sourceWriter.print("instmap.put(");
      sourceWriter.print(clientClass.getName());
      sourceWriter.print(".class, ");
      sourceWriter.print(instantiator);
      sourceWriter.print(");");
    }
    sourceWriter.print("}");
    connectorsWithInstantiator.add(clientClass);
  }
  sourceWriter.println("}");
  sourceWriter.println("}");
  sourceWriter.println("public Class<? extends " + componentConnectorClassName + ">[] getDeferredLoadedWidgets() {");
  sourceWriter.println("return new Class[] {");
  first=true;
  for (  Class<?> class2 : deferredWidgets) {
    if (!first) {
      sourceWriter.println(",");
    }
    first=false;
    sourceWriter.print(class2.getName() + ".class");
  }
  sourceWriter.println("};");
  sourceWriter.println("}");
  sourceWriter.println("public " + componentConnectorClassName + " instantiate(Class<? extends "+ componentConnectorClassName+ "> classType) {");
  sourceWriter.indent();
  sourceWriter.println(componentConnectorClassName + " p = super.instantiate(classType); if(p!= null) return p;");
  sourceWriter.println("return instmap.get(classType).get();");
  sourceWriter.outdent();
  sourceWriter.println("}");
}
