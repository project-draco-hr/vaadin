{
  Collection<Class<?>> deferredWidgets=new LinkedList<Class<?>>();
  sourceWriter.println("public void ensureInstantiator(Class<? extends " + paintableClassName + "> classType) {");
  sourceWriter.println("if(!instmap.containsKey(classType)){");
  boolean first=true;
  ArrayList<Class<? extends Paintable>> lazyLoadedWidgets=new ArrayList<Class<? extends Paintable>>();
  HashSet<Class<? extends com.vaadin.terminal.gwt.client.VPaintableWidget>> widgetsWithInstantiator=new HashSet<Class<? extends com.vaadin.terminal.gwt.client.VPaintableWidget>>();
  for (  Class<? extends Paintable> class1 : paintablesHavingWidgetAnnotation) {
    Class<? extends com.vaadin.terminal.gwt.client.VPaintableWidget> clientClass=getClientClass(class1);
    if (widgetsWithInstantiator.contains(clientClass)) {
      continue;
    }
    if (clientClass == VViewPaintable.class) {
      continue;
    }
    if (!first) {
      sourceWriter.print(" else ");
    }
 else {
      first=false;
    }
    sourceWriter.print("if( classType == " + clientClass.getName() + ".class) {");
    String instantiator="new WidgetInstantiator() {\n public " + paintableClassName + " get() {\n return GWT.create("+ clientClass.getName()+ ".class );\n}\n}\n";
    LoadStyle loadStyle=getLoadStyle(class1);
    if (loadStyle != LoadStyle.EAGER) {
      sourceWriter.print("ApplicationConfiguration.startWidgetLoading();\n" + "GWT.runAsync( \n" + "new WidgetLoader() { void addInstantiator() {instmap.put(" + clientClass.getName() + ".class,"+ instantiator+ ");}});\n");
      lazyLoadedWidgets.add(class1);
      if (loadStyle == LoadStyle.DEFERRED) {
        deferredWidgets.add(class1);
      }
    }
 else {
      sourceWriter.print("instmap.put(");
      sourceWriter.print(clientClass.getName());
      sourceWriter.print(".class, ");
      sourceWriter.print(instantiator);
      sourceWriter.print(");");
    }
    sourceWriter.print("}");
    widgetsWithInstantiator.add(clientClass);
  }
  sourceWriter.println("}");
  sourceWriter.println("}");
  sourceWriter.println("public Class<? extends " + paintableClassName + ">[] getDeferredLoadedWidgets() {");
  sourceWriter.println("return new Class[] {");
  first=true;
  for (  Class<?> class2 : deferredWidgets) {
    if (!first) {
      sourceWriter.println(",");
    }
    first=false;
    ClientWidget annotation=class2.getAnnotation(ClientWidget.class);
    Class<? extends com.vaadin.terminal.gwt.client.VPaintableWidget> value=annotation.value();
    sourceWriter.print(value.getName() + ".class");
  }
  sourceWriter.println("};");
  sourceWriter.println("}");
  sourceWriter.println("public " + paintableClassName + " instantiate(Class<? extends "+ paintableClassName+ "> classType) {");
  sourceWriter.indent();
  sourceWriter.println(paintableClassName + " p = super.instantiate(classType); if(p!= null) return p;");
  sourceWriter.println("return instmap.get(classType).get();");
  sourceWriter.outdent();
  sourceWriter.println("}");
}
