{
  boolean repaintAll=(request.getParameter(GET_PARAM_REPAINT_ALL) != null) || request.getSession().isNew();
  final OutputStream out=response.getOutputStream();
  final PrintWriter outWriter=new PrintWriter(new BufferedWriter(new OutputStreamWriter(out,"UTF-8")));
  try {
synchronized (application) {
      Window window=null;
      if (application.isRunning()) {
        window=getApplicationWindow(request,application);
        if (window == null) {
          System.err.println("Warning, could not get window for application with request URI " + request.getRequestURI());
          return;
        }
      }
 else {
        endApplication(request,response,application);
        return;
      }
      if (repaintAll) {
        for (final Iterator it=idPaintableMap.keySet().iterator(); it.hasNext(); ) {
          final Component c=(Component)idPaintableMap.get(it.next());
          if (isChildOf(window,c)) {
            it.remove();
            paintableIdMap.remove(c);
          }
        }
      }
      handleVariables(request,application);
      if (!application.isRunning()) {
        endApplication(request,response,application);
        return;
      }
      response.setContentType("application/json; charset=UTF-8");
      outWriter.print("for(;;);[{");
      outWriter.print("\"changes\":[");
      Window newWindow=getApplicationWindow(request,application);
      if (newWindow != window) {
        window=newWindow;
        repaintAll=true;
      }
      JsonPaintTarget paintTarget=new JsonPaintTarget(this,outWriter,!repaintAll);
      ArrayList paintables;
      if (repaintAll) {
        paintables=new ArrayList();
        paintables.add(window);
        locales=null;
        requireLocale(application.getLocale().toString());
      }
 else {
        for (Iterator it=paintableIdMap.keySet().iterator(); it.hasNext(); ) {
          Component p=(Component)it.next();
          if (p.getApplication() == null) {
            idPaintableMap.remove(paintableIdMap.get(p));
            it.remove();
            dirtyPaintabletSet.remove(p);
          }
        }
        paintables=getDirtyComponents(window);
      }
      if (paintables != null) {
        Collections.sort(paintables,new Comparator(){
          public int compare(          Object o1,          Object o2){
            final Component c1=(Component)o1;
            final Component c2=(Component)o2;
            if (isChildOf(c1,c2)) {
              return -1;
            }
            if (isChildOf(c2,c1)) {
              return 1;
            }
            return 0;
          }
        }
);
        for (final Iterator i=paintables.iterator(); i.hasNext(); ) {
          final Paintable p=(Paintable)i.next();
          if (p instanceof Window) {
            final Window w=(Window)p;
            if (w.getTerminal() == null) {
              w.setTerminal(application.getMainWindow().getTerminal());
            }
          }
          if (paintTarget.needsToBePainted(p)) {
            paintTarget.startTag("change");
            paintTarget.addAttribute("format","uidl");
            final String pid=getPaintableId(p);
            paintTarget.addAttribute("pid",pid);
            paintTarget.setTrackPaints(true);
            p.paint(paintTarget);
            if (paintTarget.getNumberOfPaints() <= 0) {
              paintTarget.addAttribute("visible",false);
            }
            paintTarget.endTag("change");
          }
          paintablePainted(p);
        }
      }
      paintTarget.close();
      outWriter.print("]");
      outWriter.print(", \"meta\" : {");
      boolean metaOpen=false;
      if (repaintAll) {
        metaOpen=true;
        outWriter.write("\"repaintAll\":true");
      }
      final Paintable f=(Paintable)application.consumeFocus();
      if (f != null) {
        if (metaOpen) {
          outWriter.write(",");
        }
        outWriter.write("\"focus\":\"" + getPaintableId(f) + "\"");
      }
      outWriter.print("}, \"resources\" : {");
      String themeName=window.getTheme();
      if (request.getParameter("theme") != null) {
        themeName=request.getParameter("theme");
      }
      if (themeName == null) {
        themeName="default";
      }
      int resourceIndex=0;
      for (final Iterator i=paintTarget.getPreCachedResources().iterator(); i.hasNext(); ) {
        final String resource=(String)i.next();
        InputStream is=null;
        try {
          is=applicationServlet.getServletContext().getResourceAsStream("/" + ApplicationServlet.THEME_DIRECTORY_PATH + themeName+ "/"+ resource);
        }
 catch (        final Exception e) {
          e.printStackTrace();
        }
        if (is != null) {
          outWriter.print((resourceIndex++ > 0 ? ", " : "") + "\"" + resource+ "\" : ");
          final StringBuffer layout=new StringBuffer();
          try {
            final InputStreamReader r=new InputStreamReader(is);
            final char[] buffer=new char[20000];
            int charsRead=0;
            while ((charsRead=r.read(buffer)) > 0) {
              layout.append(buffer,0,charsRead);
            }
            r.close();
          }
 catch (          final java.io.IOException e) {
            System.err.println("Resource transfer failed:  " + request.getRequestURI() + ". ("+ e.getMessage()+ ")");
          }
          outWriter.print("\"" + JsonPaintTarget.escapeJSON(layout.toString()) + "\"");
        }
      }
      outWriter.print("}");
      printLocaleDeclarations(outWriter);
      outWriter.print("}]");
      outWriter.flush();
      outWriter.close();
    }
    out.flush();
    out.close();
  }
 catch (  SocketException e) {
    System.err.println("Warning: SocketException in CommunicationManager." + " Most likely client (browser) closed socket.");
  }
catch (  final Throwable e) {
    e.printStackTrace();
    final OutputStreamWriter w=new OutputStreamWriter(out);
    final PrintWriter err=new PrintWriter(w);
    err.write("<html><head><title>Application Internal Error</title></head><body>");
    err.write("<h1>" + e.toString() + "</h1><pre>\n");
    e.printStackTrace(new PrintWriter(err));
    err.write("\n</pre></body></html>");
    err.close();
  }
}
