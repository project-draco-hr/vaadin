{
  UI uI=connector.getUI();
  ConnectorTracker connectorTracker=uI.getConnectorTracker();
  Class<? extends SharedState> stateType=connector.getStateType();
  Object diffState=connectorTracker.getDiffState(connector);
  if (diffState == null) {
    boolean supportsDiffState=!JavaScriptConnectorState.class.isAssignableFrom(stateType);
    if (supportsDiffState) {
      diffState=new JSONObject();
      try {
        SharedState referenceState=stateType.newInstance();
        diffState=JsonCodec.encode(referenceState,null,stateType,uI.getConnectorTracker());
      }
 catch (      Exception e) {
        getLogger().log(Level.WARNING,"Error creating reference object for state of type " + stateType.getName());
      }
      connectorTracker.setDiffState(connector,diffState);
    }
  }
  JSONObject stateJson=(JSONObject)JsonCodec.encode(state,diffState,stateType,uI.getConnectorTracker());
  return stateJson;
}
