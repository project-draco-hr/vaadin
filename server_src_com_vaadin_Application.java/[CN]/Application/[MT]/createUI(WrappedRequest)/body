{
  Class<? extends UI> uiClass=getUIClass(request);
  UI ui=createUIInstance(request,uiClass);
  if (ui.getApplication() == null) {
    ui.setApplication(this);
  }
  Integer uiId=Integer.valueOf(nextUIId++);
  uIs.put(uiId,ui);
  UI.setCurrent(ui);
  ui.doInit(request,uiId.intValue());
  if (getUiProvider(request,uiClass).isUiPreserved(request,uiClass)) {
    String windowName=request.getBrowserDetails().getWindowName();
    if (windowName == null) {
      getLogger().warning("There is no window.name available for UI " + uiClass + " that should be preserved.");
    }
 else {
      retainOnRefreshUIs.put(windowName,uiId);
    }
  }
  return ui;
}
