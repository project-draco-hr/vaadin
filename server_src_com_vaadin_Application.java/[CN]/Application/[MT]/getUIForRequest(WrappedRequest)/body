{
  UI uI=UI.getCurrent();
  if (uI != null) {
    return uI;
  }
  Integer uiId=getUIId(request);
synchronized (this) {
    BrowserDetails browserDetails=request.getBrowserDetails();
    boolean hasBrowserDetails=browserDetails != null && browserDetails.getUriFragment() != null;
    uI=uIs.get(uiId);
    Class<? extends UI> uiClass=null;
    if (uI == null && hasBrowserDetails && !retainOnRefreshUIs.isEmpty()) {
      uiClass=getUIClass(request);
      @SuppressWarnings("null") String windowName=browserDetails.getWindowName();
      Integer retainedUIId=retainOnRefreshUIs.get(windowName);
      if (retainedUIId != null) {
        UI retainedUI=uIs.get(retainedUIId);
        if (retainedUI.getClass() == uiClass) {
          uiId=retainedUIId;
          uI=retainedUI;
        }
 else {
          getLogger().info("Not using retained UI in " + windowName + " because retained UI was of type "+ retainedUIId.getClass()+ " but "+ uiClass+ " is expected for the request.");
        }
      }
    }
  }
  UI.setCurrent(uI);
  return uI;
}
