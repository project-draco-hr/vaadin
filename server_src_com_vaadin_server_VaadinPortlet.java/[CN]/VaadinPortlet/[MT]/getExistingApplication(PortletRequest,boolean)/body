{
  final PortletSession session=request.getPortletSession(allowSessionCreation);
  if (session == null) {
    throw new SessionExpiredException();
  }
  Application application=Application.getForSession(new WrappedPortletSession(session));
  if (application == null) {
    return null;
  }
  if (!application.isRunning()) {
    application.removeFromSession();
    return null;
  }
  return application;
}
