{
  PortletRequest request=wrappedRequest.getPortletRequest();
  boolean requestCanCreateApplication=requestCanCreateApplication(request,requestType);
  VaadinSession application=getExistingApplication(request,requestCanCreateApplication);
  if (application != null) {
    final boolean restartApplication=(wrappedRequest.getParameter(URL_PARAMETER_RESTART_APPLICATION) != null);
    final boolean closeApplication=(wrappedRequest.getParameter(URL_PARAMETER_CLOSE_APPLICATION) != null);
    if (restartApplication) {
      closeApplication(application,request.getPortletSession(false));
      return createAndRegisterApplication(request);
    }
 else     if (closeApplication) {
      closeApplication(application,request.getPortletSession(false));
      return null;
    }
 else {
      return application;
    }
  }
  if (requestCanCreateApplication) {
    return createAndRegisterApplication(request);
  }
 else {
    throw new SessionExpiredException();
  }
}
