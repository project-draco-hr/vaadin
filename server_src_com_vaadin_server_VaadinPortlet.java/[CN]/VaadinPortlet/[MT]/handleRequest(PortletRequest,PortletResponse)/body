{
  RequestTimer requestTimer=new RequestTimer();
  requestTimer.start();
  CurrentInstance.clearAll();
  setCurrent(this);
  try {
    AbstractApplicationPortletWrapper portletWrapper=new AbstractApplicationPortletWrapper(this);
    VaadinPortletRequest vaadinRequest=createVaadinRequest(request);
    VaadinPortletResponse vaadinResponse=new VaadinPortletResponse(response,getService());
    getService().setCurrentInstances(vaadinRequest,vaadinResponse);
    RequestType requestType=getRequestType(vaadinRequest);
    if (requestType == RequestType.UNKNOWN) {
      handleUnknownRequest(request,response);
    }
 else     if (requestType == RequestType.DUMMY) {
      ((ResourceResponse)response).setContentType("text/html");
      final OutputStream out=((ResourceResponse)response).getPortletOutputStream();
      final PrintWriter outWriter=new PrintWriter(new BufferedWriter(new OutputStreamWriter(out,"UTF-8")));
      outWriter.print("<html><body>dummy page</body></html>");
      outWriter.close();
    }
 else     if (requestType == RequestType.STATIC_FILE) {
      serveStaticResources((ResourceRequest)request,(ResourceResponse)response);
    }
 else {
      VaadinPortletSession vaadinSession=null;
      try {
        vaadinSession=(VaadinPortletSession)getService().findVaadinSession(vaadinRequest);
        if (vaadinSession == null) {
          return;
        }
        if (requestType == RequestType.PUBLISHED_FILE) {
          new PublishedFileHandler().handleRequest(vaadinSession,vaadinRequest,vaadinResponse);
          return;
        }
 else         if (requestType == RequestType.HEARTBEAT) {
          new HeartbeatHandler().handleRequest(vaadinSession,vaadinRequest,vaadinResponse);
          return;
        }
        new PortletListenerNotifier().handleRequest(vaadinSession,vaadinRequest,vaadinResponse);
        if (requestType == RequestType.FILE_UPLOAD) {
          new FileUploadHandler().handleRequest(vaadinSession,vaadinRequest,vaadinResponse);
          return;
        }
 else         if (requestType == RequestType.BROWSER_DETAILS) {
          new UIInitHandler().handleRequest(vaadinSession,vaadinRequest,vaadinResponse);
          return;
        }
 else         if (requestType == RequestType.UIDL) {
          new UidlRequestHandler(portletWrapper).handleRequest(vaadinSession,vaadinRequest,vaadinResponse);
          return;
        }
 else {
          handleOtherRequest(vaadinRequest,vaadinResponse,requestType,vaadinSession,vaadinSession.getCommunicationManager());
        }
      }
 catch (      final SessionExpiredException e) {
        getLogger().finest("A user session has expired");
      }
catch (      final Throwable e) {
        handleServiceException(vaadinRequest,vaadinResponse,vaadinSession,e);
      }
 finally {
        if (vaadinSession != null) {
          getService().cleanupSession(vaadinSession);
          requestTimer.stop(vaadinSession);
        }
      }
    }
  }
  finally {
    CurrentInstance.clearAll();
  }
}
