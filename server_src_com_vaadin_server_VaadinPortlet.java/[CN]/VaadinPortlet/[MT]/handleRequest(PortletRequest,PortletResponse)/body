{
  RequestTimer requestTimer=new RequestTimer();
  requestTimer.start();
  CurrentInstance.clearAll();
  setCurrent(this);
  try {
    AbstractApplicationPortletWrapper portletWrapper=new AbstractApplicationPortletWrapper(this);
    WrappedPortletRequest wrappedRequest=createWrappedRequest(request);
    WrappedPortletResponse wrappedResponse=new WrappedPortletResponse(response,getVaadinService());
    getVaadinService().setCurrentInstances(wrappedRequest,wrappedResponse);
    RequestType requestType=getRequestType(wrappedRequest);
    if (requestType == RequestType.UNKNOWN) {
      handleUnknownRequest(request,response);
    }
 else     if (requestType == RequestType.DUMMY) {
      ((ResourceResponse)response).setContentType("text/html");
      final OutputStream out=((ResourceResponse)response).getPortletOutputStream();
      final PrintWriter outWriter=new PrintWriter(new BufferedWriter(new OutputStreamWriter(out,"UTF-8")));
      outWriter.print("<html><body>dummy page</body></html>");
      outWriter.close();
    }
 else     if (requestType == RequestType.STATIC_FILE) {
      serveStaticResources((ResourceRequest)request,(ResourceResponse)response);
    }
 else {
      VaadinPortletSession vaadinSession=null;
      boolean sessionProcessed=false;
      try {
        vaadinSession=(VaadinPortletSession)getVaadinService().findVaadinSession(wrappedRequest);
        if (vaadinSession == null) {
          return;
        }
        VaadinSession.setCurrent(vaadinSession);
        request.setAttribute(VaadinSession.class.getName(),vaadinSession);
        PortletCommunicationManager communicationManager=(PortletCommunicationManager)vaadinSession.getCommunicationManager();
        if (requestType == RequestType.CONNECTOR_RESOURCE) {
          communicationManager.serveConnectorResource(wrappedRequest,wrappedResponse);
          return;
        }
 else         if (requestType == RequestType.HEARTBEAT) {
          communicationManager.handleHeartbeatRequest(wrappedRequest,wrappedResponse,vaadinSession);
          return;
        }
        vaadinSession.getBrowser().updateRequestDetails(wrappedRequest);
        sessionProcessed=true;
        UI uI=null;
        vaadinSession.getLock().lock();
        try {
switch (requestType) {
case RENDER:
case ACTION:
            uI=vaadinSession.getUIForRequest(wrappedRequest);
          break;
case BROWSER_DETAILS:
        break;
case FILE_UPLOAD:
      break;
case APP:
    break;
default :
  uI=vaadinSession.getUIForRequest(wrappedRequest);
}
}
  finally {
vaadinSession.getLock().unlock();
}
if (request instanceof RenderRequest) {
vaadinSession.firePortletRenderRequest(uI,(RenderRequest)request,(RenderResponse)response);
}
 else if (request instanceof ActionRequest) {
vaadinSession.firePortletActionRequest(uI,(ActionRequest)request,(ActionResponse)response);
}
 else if (request instanceof EventRequest) {
vaadinSession.firePortletEventRequest(uI,(EventRequest)request,(EventResponse)response);
}
 else if (request instanceof ResourceRequest) {
vaadinSession.firePortletResourceRequest(uI,(ResourceRequest)request,(ResourceResponse)response);
}
if (requestType == RequestType.FILE_UPLOAD) {
communicationManager.handleFileUpload(vaadinSession,wrappedRequest,wrappedResponse);
return;
}
 else if (requestType == RequestType.BROWSER_DETAILS) {
communicationManager.handleBrowserDetailsRequest(wrappedRequest,wrappedResponse,vaadinSession);
return;
}
 else if (requestType == RequestType.UIDL) {
communicationManager.handleUidlRequest(wrappedRequest,wrappedResponse,portletWrapper,uI);
return;
}
 else {
handleOtherRequest(wrappedRequest,wrappedResponse,requestType,vaadinSession,communicationManager);
}
}
 catch (final SessionExpiredException e) {
getLogger().finest("A user session has expired");
}
catch (final GeneralSecurityException e) {
getLogger().fine("General security exception, the security key was probably incorrect.");
}
catch (final Throwable e) {
handleServiceException(wrappedRequest,wrappedResponse,vaadinSession,e);
}
 finally {
if (sessionProcessed) {
vaadinSession.cleanupInactiveUIs();
}
if (vaadinSession != null) {
requestTimer.stop(vaadinSession);
}
}
}
}
  finally {
CurrentInstance.clearAll();
}
}
