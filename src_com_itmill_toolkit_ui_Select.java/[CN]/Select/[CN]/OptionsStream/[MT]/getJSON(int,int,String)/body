{
  if (!currentFilter.equals(filter) || filteredItemsBuffer == null) {
    filteredItemsBuffer=filterContent(filter);
    currentFilter=filter;
  }
  ArrayList keys=new ArrayList();
  ArrayList values=new ArrayList();
  for (int i=first; i < first + size && i < filteredItemsBuffer.size(); i++) {
    Object id=filteredItemsBuffer.get(i);
    Item item=getItem(id);
    keys.add(Select.this.itemIdMapper.key(id));
    if (getItemCaptionMode() == ITEM_CAPTION_MODE_PROPERTY)     try {
      values.add(URLEncoder.encode(item.getItemProperty(getItemCaptionPropertyId()).getValue().toString(),"ISO-8859-1"));
    }
 catch (    UnsupportedEncodingException e) {
      e.printStackTrace();
    }
 else     values.add(String.valueOf(id));
  }
  StringBuffer json=new StringBuffer();
  json.append("{\"keys\":[");
  addToJSONArray(json,keys);
  json.append("],\"total\":" + this.filteredItemsBuffer.size());
  json.append(",\"values\":[");
  addToJSONArray(json,values);
  json.append("]}");
  return json.toString();
}
