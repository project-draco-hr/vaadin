{
  if (getFocusableId() > 0) {
    target.addAttribute("focusid",getFocusableId());
  }
  if (getTabIndex() > 0) {
    target.addAttribute("tabindex",getTabIndex());
  }
  if (isModified()) {
    target.addAttribute("modified",true);
  }
  if (isRequired()) {
    target.addAttribute("required",true);
  }
  if (isMultiSelect()) {
    target.addAttribute("selectmode","multi");
  }
  if (isNewItemsAllowed()) {
    target.addAttribute("allownewitem",true);
  }
  boolean needNullSelectOption=false;
  if (isNullSelectionAllowed()) {
    target.addAttribute("nullselect",true);
    needNullSelectOption=getNullSelectionItemId() == null;
  }
  String[] selectedKeys;
  if (isMultiSelect()) {
    selectedKeys=new String[((Set)getValue()).size()];
  }
 else {
    selectedKeys=new String[(getValue() == null && getNullSelectionItemId() == null ? 0 : 1)];
  }
  target.addAttribute("filteringmode",getFilteringMode());
  int keyIndex=0;
  target.startTag("options");
  boolean paintNullSelection=needNullSelectOption && (currentPage == 0 && (filterstring == null || filterstring.equals("") || filterstring.equals("-")));
  if (paintNullSelection) {
    target.startTag("so");
    target.addAttribute("caption","-");
    target.addAttribute("key","");
    target.endTag("so");
  }
  List options=getFilteredOptions();
  if (options.size() > this.pageLength) {
    int first=this.currentPage * this.pageLength;
    int last=first + this.pageLength;
    if (needNullSelectOption) {
      if (currentPage > 0) {
        first--;
      }
      last--;
    }
    if (options.size() < last) {
      last=options.size();
    }
    options=options.subList(first,last);
  }
  Iterator i=options.iterator();
  while (i.hasNext()) {
    Object id=i.next();
    String key=this.itemIdMapper.key(id);
    String caption=getItemCaption(id);
    Resource icon=getItemIcon(id);
    target.startTag("so");
    if (icon != null) {
      target.addAttribute("icon",icon);
    }
    target.addAttribute("caption",caption);
    if (id != null && id.equals(getNullSelectionItemId())) {
      target.addAttribute("nullselection",true);
    }
    target.addAttribute("key",key);
    if (isSelected(id) && keyIndex < selectedKeys.length) {
      target.addAttribute("selected",true);
      selectedKeys[keyIndex++]=key;
    }
    target.endTag("so");
  }
  target.endTag("options");
  target.addAttribute("totalitems",size() + (needNullSelectOption ? 1 : 0));
  if (this.filteredOptions != null) {
    target.addAttribute("totalMatches",this.filteredOptions.size() + (needNullSelectOption ? 1 : 0));
  }
  target.addVariable(this,"selected",selectedKeys);
  if (isNewItemsAllowed()) {
    target.addVariable(this,"newitem","");
  }
  target.addVariable(this,"filter",this.filterstring);
  target.addVariable(this,"page",this.currentPage);
}
