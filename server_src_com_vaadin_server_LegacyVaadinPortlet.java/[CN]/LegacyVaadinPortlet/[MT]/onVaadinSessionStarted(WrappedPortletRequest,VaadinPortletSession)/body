{
  if (shouldCreateApplication(request)) {
    VaadinSession.setCurrent(session);
    session.getBrowser().updateRequestDetails(request);
    LegacyApplication legacyApplication=getNewApplication(request.getPortletRequest());
    legacyApplication.doInit();
    session.addUIProvider(legacyApplication);
  }
}
