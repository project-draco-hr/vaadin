{
  super.updateFromUIDL(uidl,client);
  if (!isRealUpdate(uidl)) {
    return;
  }
  getWidgetForPaintable().htmlContentAllowed=uidl.hasAttribute(VMenuBar.HTML_CONTENT_ALLOWED);
  getWidgetForPaintable().openRootOnHover=uidl.getBooleanAttribute(VMenuBar.OPEN_ROOT_MENU_ON_HOWER);
  getWidgetForPaintable().enabled=!uidl.getBooleanAttribute(ATTRIBUTE_DISABLED);
  getWidgetForPaintable().client=client;
  getWidgetForPaintable().uidlId=uidl.getId();
  if (!getWidgetForPaintable().getItems().isEmpty()) {
    getWidgetForPaintable().clearItems();
  }
  UIDL options=uidl.getChildUIDL(0);
  if (null != getState() && !getState().isUndefinedWidth()) {
    UIDL moreItemUIDL=options.getChildUIDL(0);
    StringBuffer itemHTML=new StringBuffer();
    if (moreItemUIDL.hasAttribute("icon")) {
      itemHTML.append("<img src=\"" + Util.escapeAttribute(client.translateVaadinUri(moreItemUIDL.getStringAttribute("icon"))) + "\" class=\""+ Icon.CLASSNAME+ "\" alt=\"\" />");
    }
    String moreItemText=moreItemUIDL.getStringAttribute("text");
    if ("".equals(moreItemText)) {
      moreItemText="&#x25BA;";
    }
    itemHTML.append(moreItemText);
    getWidgetForPaintable().moreItem=GWT.create(CustomMenuItem.class);
    getWidgetForPaintable().moreItem.setHTML(itemHTML.toString());
    getWidgetForPaintable().moreItem.setCommand(VMenuBar.emptyCommand);
    getWidgetForPaintable().collapsedRootItems=new VMenuBar(true,getWidgetForPaintable());
    getWidgetForPaintable().moreItem.setSubMenu(getWidgetForPaintable().collapsedRootItems);
    getWidgetForPaintable().moreItem.addStyleName(VMenuBar.CLASSNAME + "-more-menuitem");
  }
  UIDL uidlItems=uidl.getChildUIDL(1);
  Iterator<Object> itr=uidlItems.getChildIterator();
  Stack<Iterator<Object>> iteratorStack=new Stack<Iterator<Object>>();
  Stack<VMenuBar> menuStack=new Stack<VMenuBar>();
  VMenuBar currentMenu=getWidgetForPaintable();
  while (itr.hasNext()) {
    UIDL item=(UIDL)itr.next();
    CustomMenuItem currentItem=null;
    final int itemId=item.getIntAttribute("id");
    boolean itemHasCommand=item.hasAttribute("command");
    boolean itemIsCheckable=item.hasAttribute(VMenuBar.ATTRIBUTE_CHECKED);
    String itemHTML=getWidgetForPaintable().buildItemHTML(item);
    Command cmd=null;
    if (!item.hasAttribute("separator")) {
      if (itemHasCommand || itemIsCheckable) {
        cmd=new Command(){
          public void execute(){
            getWidgetForPaintable().hostReference.onMenuClick(itemId);
          }
        }
;
      }
    }
    currentItem=currentMenu.addItem(itemHTML.toString(),cmd);
    currentItem.updateFromUIDL(item,client);
    if (item.getChildCount() > 0) {
      menuStack.push(currentMenu);
      iteratorStack.push(itr);
      itr=item.getChildIterator();
      currentMenu=new VMenuBar(true,currentMenu);
      if (uidl.hasAttribute("style")) {
        for (        String style : uidl.getStringAttribute("style").split(" ")) {
          currentMenu.addStyleDependentName(style);
        }
      }
      currentItem.setSubMenu(currentMenu);
    }
    while (!itr.hasNext() && !iteratorStack.empty()) {
      boolean hasCheckableItem=false;
      for (      CustomMenuItem menuItem : currentMenu.getItems()) {
        hasCheckableItem=hasCheckableItem || menuItem.isCheckable();
      }
      if (hasCheckableItem) {
        currentMenu.addStyleDependentName("check-column");
      }
 else {
        currentMenu.removeStyleDependentName("check-column");
      }
      itr=iteratorStack.pop();
      currentMenu=menuStack.pop();
    }
  }
  getWidgetForPaintable().iLayout(false);
}
