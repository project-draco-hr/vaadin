{
  initialPaint=false;
  if (partialUpdate) {
    target.addAttribute("partialUpdate",true);
    target.addAttribute("rootKey",itemIdMapper.key(expandedItemId));
  }
 else {
    getCaptionChangeListener().clear();
    if (getTabIndex() > 0) {
      target.addAttribute("tabindex",getTabIndex());
    }
    if (isSelectable()) {
      target.addAttribute("selectmode",(isMultiSelect() ? "multi" : "single"));
    }
 else {
      target.addAttribute("selectmode","none");
    }
    if (isNewItemsAllowed()) {
      target.addAttribute("allownewitem",true);
    }
    if (isNullSelectionAllowed()) {
      target.addAttribute("nullselect",true);
    }
  }
  final Set actionSet=new LinkedHashSet();
  String[] selectedKeys;
  if (isMultiSelect()) {
    selectedKeys=new String[((Set)getValue()).size()];
  }
 else {
    selectedKeys=new String[(getValue() == null ? 0 : 1)];
  }
  int keyIndex=0;
  final LinkedList expandedKeys=new LinkedList();
  final Stack iteratorStack=new Stack();
  Collection ids;
  if (partialUpdate) {
    ids=getChildren(expandedItemId);
  }
 else {
    ids=rootItemIds();
  }
  if (ids != null) {
    iteratorStack.push(ids.iterator());
  }
  while (!iteratorStack.isEmpty()) {
    final Iterator i=(Iterator)iteratorStack.peek();
    if (!i.hasNext()) {
      iteratorStack.pop();
      if (!iteratorStack.isEmpty()) {
        target.endTag("node");
      }
    }
 else {
      final Object itemId=i.next();
      final boolean isNode=areChildrenAllowed(itemId) && hasChildren(itemId);
      if (isNode) {
        target.startTag("node");
      }
 else {
        target.startTag("leaf");
      }
      target.addAttribute("caption",getItemCaption(itemId));
      final Resource icon=getItemIcon(itemId);
      if (icon != null) {
        target.addAttribute("icon",getItemIcon(itemId));
      }
      final String key=itemIdMapper.key(itemId);
      target.addAttribute("key",key);
      if (isSelected(itemId)) {
        target.addAttribute("selected",true);
        try {
          selectedKeys[keyIndex++]=key;
        }
 catch (        Exception e) {
          e.printStackTrace();
        }
      }
      if (areChildrenAllowed(itemId) && isExpanded(itemId)) {
        target.addAttribute("expanded",true);
        expandedKeys.add(key);
      }
      getCaptionChangeListener().addNotifierForItem(itemId);
      if (actionHandlers != null) {
        final ArrayList keys=new ArrayList();
        for (final Iterator ahi=actionHandlers.iterator(); ahi.hasNext(); ) {
          final Action[] aa=((Action.Handler)ahi.next()).getActions(itemId,this);
          if (aa != null) {
            for (int ai=0; ai < aa.length; ai++) {
              final String akey=actionMapper.key(aa[ai]);
              actionSet.add(aa[ai]);
              keys.add(akey);
            }
          }
        }
        target.addAttribute("al",keys.toArray());
      }
      if (isExpanded(itemId) && hasChildren(itemId) && areChildrenAllowed(itemId)) {
        iteratorStack.push(getChildren(itemId).iterator());
      }
 else {
        if (isNode) {
          target.endTag("node");
        }
 else {
          target.endTag("leaf");
        }
      }
    }
  }
  if (!actionSet.isEmpty()) {
    target.addVariable(this,"action","");
    target.startTag("actions");
    for (final Iterator i=actionSet.iterator(); i.hasNext(); ) {
      final Action a=(Action)i.next();
      target.startTag("action");
      if (a.getCaption() != null) {
        target.addAttribute("caption",a.getCaption());
      }
      if (a.getIcon() != null) {
        target.addAttribute("icon",a.getIcon());
      }
      target.addAttribute("key",actionMapper.key(a));
      target.endTag("action");
    }
    target.endTag("actions");
  }
  if (partialUpdate) {
    partialUpdate=false;
  }
 else {
    target.addVariable(this,"selected",selectedKeys);
    target.addVariable(this,"expand",new String[]{});
    target.addVariable(this,"collapse",new String[]{});
    target.addVariable(this,"newitem",new String[]{});
  }
}
