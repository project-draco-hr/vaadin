{
  final String[] ka=(String[])variables.get("selected");
  final String[] ranges=(String[])variables.get("selectedRanges");
  Set<Object> renderedItemIds=getCurrentlyRenderedItemIds();
  HashSet<Object> newValue=new HashSet<Object>((Collection<Object>)getValue());
  if (variables.containsKey("clearSelections")) {
    newValue.clear();
  }
 else {
    newValue.removeAll(renderedItemIds);
  }
  for (int i=0; i < ka.length; i++) {
    final Object id=itemIdMapper.get(ka[i]);
    if (!isNullSelectionAllowed() && (id == null || id == getNullSelectionItemId())) {
      requestRepaint();
    }
 else     if (id != null && containsId(id)) {
      newValue.add(id);
    }
  }
  if (!isNullSelectionAllowed() && newValue.size() < 1) {
    requestRepaint();
    return;
  }
  if (ranges != null) {
    for (    String range : ranges) {
      String[] split=range.split("-");
      Object startItemId=itemIdMapper.get(split[0]);
      int length=Integer.valueOf(split[1]);
      newValue.addAll(getItemIdsInRange(startItemId,length));
    }
  }
  setValue(newValue,true);
}
