{
  DesiredCapabilities capabilities;
  Browser runLocallyBrowser=getRunLocallyBrowser();
  if (runLocallyBrowser != null) {
    if (System.getenv().containsKey("TEAMCITY_VERSION")) {
      throw new RuntimeException("@RunLocally is not supported for tests run on the build server");
    }
    capabilities=runLocallyBrowser.getDesiredCapabilities();
    setupLocalDriver(capabilities);
  }
 else {
    capabilities=getDesiredCapabilities();
    for (int i=1; i <= BROWSER_INIT_ATTEMPTS; i++) {
      try {
        if (localWebDriverIsUsed()) {
          setupLocalDriver(capabilities);
        }
 else {
          setupRemoteDriver(capabilities);
        }
        break;
      }
 catch (      Exception e) {
        System.err.println("Browser startup for " + capabilities + " failed on attempt "+ i+ ": "+ e.getMessage());
        if (i == BROWSER_INIT_ATTEMPTS) {
          throw e;
        }
      }
    }
  }
  int w=SCREENSHOT_WIDTH;
  int h=SCREENSHOT_HEIGHT;
  if (BrowserUtil.isIE8(capabilities)) {
    w+=4;
    h+=4;
  }
  try {
    testBench().resizeViewPortTo(w,h);
  }
 catch (  UnsupportedOperationException e) {
  }
}
