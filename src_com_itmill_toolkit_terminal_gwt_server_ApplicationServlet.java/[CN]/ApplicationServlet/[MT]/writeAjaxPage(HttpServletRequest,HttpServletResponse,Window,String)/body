{
  response.setContentType("text/html");
  final BufferedWriter page=new BufferedWriter(new OutputStreamWriter(response.getOutputStream()));
  final String pathInfo=request.getPathInfo() == null ? "/" : request.getPathInfo();
  page.write("<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" " + "\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n");
  page.write("<html xmlns=\"http://www.w3.org/1999/xhtml\" style=\"width:100%;" + "height:100%;border:0;margin:0;\">\n<head>\n<title>IT Mill Toolkit 5</title>\n" + "<script type=\"text/javascript\">\n"+ "	var itmill = {\n"+ "		appUri:'");
  String appUrl="";
  String widgetsetUrl="";
  if (applicationRunnerMode) {
    final String[] URIparts=getApplicationRunnerURIs(request);
    widgetsetUrl=URIparts[0];
    if (widgetsetUrl.equals("/")) {
      widgetsetUrl="";
    }
    appUrl=URIparts[1];
  }
 else {
    final String[] urlParts=getApplicationUrl(request).toString().split("\\/");
    widgetsetUrl="";
    if (urlParts[3].equals(request.getContextPath())) {
      widgetsetUrl+=urlParts[3];
    }
    for (int i=3; i < urlParts.length; i++) {
      appUrl+="/" + urlParts[i];
    }
    if (appUrl.endsWith("/")) {
      appUrl=appUrl.substring(0,appUrl.length() - 1);
    }
  }
  page.write(appUrl);
  String widgetset=applicationProperties.getProperty(PARAMETER_WIDGETSET);
  if (widgetset == null) {
    widgetset=DEFAULT_WIDGETSET;
  }
  final String staticFilePath=getApplicationOrSystemProperty(PARAMETER_ITMILL_RESOURCES,widgetsetUrl);
  String themeUri=null;
  if (themeName != null) {
    themeUri=staticFilePath + "/" + THEME_DIRECTORY_PATH+ themeName;
  }
  page.write("', pathInfo: '" + pathInfo + "', themeUri: "+ (themeUri != null ? "'" + themeUri + "'" : "null")+ "\n};\n"+ "</script>\n"+ "<script language='javascript' src='"+ staticFilePath+ "/"+ WIDGETSET_DIRECTORY_PATH+ widgetset+ "/"+ widgetset+ ".nocache.js'></script>\n");
  if (themeName != null) {
    page.write("<link REL=\"stylesheet\" TYPE=\"text/css\" HREF=\"" + themeUri + "/styles.css\">\n");
  }
  page.write("</head>\n<body class=\"i-generated-body\">\n" + "	<iframe id=\"__gwt_historyFrame\" style=\"width:0;height:0;border:0;overflow:hidden\"></iframe>\n" + "	<div id=\"itmill-ajax-window\" style=\"position: absolute;top:0;left:0;width:100%;height:100%;border:0;margin:0\"></div>"+ "	</body>\n"+ "</html>\n");
  page.close();
}
