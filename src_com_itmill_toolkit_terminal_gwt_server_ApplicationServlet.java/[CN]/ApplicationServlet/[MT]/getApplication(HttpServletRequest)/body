{
  final HttpSession session=request.getSession(true);
  final Collection applications=WebApplicationContext.getApplicationContext(session).getApplications();
  for (final Iterator i=applications.iterator(); i.hasNext(); ) {
    final Application a=(Application)i.next();
    final String aPath=a.getURL().getPath();
    String servletPath=request.getContextPath() + request.getServletPath();
    if (servletPath.length() < aPath.length()) {
      servletPath+="/";
    }
    if (applicationRunnerMode) {
      if (request.getPathInfo().indexOf('/',1) == -1) {
        servletPath+=request.getPathInfo();
      }
 else {
        servletPath+=request.getPathInfo().substring(1,request.getPathInfo().indexOf('/',1));
      }
    }
    if (servletPath.equals(aPath)) {
      if (a.isRunning()) {
        return a;
      }
      WebApplicationContext.getApplicationContext(session).removeApplication(a);
      break;
    }
  }
  final WebApplicationContext context=WebApplicationContext.getApplicationContext(request.getSession());
  final URL applicationUrl=getApplicationUrl(request);
  if (applicationRunnerMode) {
    final String applicationClassName=applicationUrl.getPath().substring(applicationUrl.getPath().lastIndexOf('/') + 1);
    try {
      applicationClass=classLoader.loadClass(applicationClassName);
    }
 catch (    final ClassNotFoundException e) {
      throw new InstantiationException("Failed to load application class: " + applicationClassName);
    }
  }
  try {
    final Application application=(Application)applicationClass.newInstance();
    context.addApplication(application);
    application.setLocale(request.getLocale());
    application.start(applicationUrl,applicationProperties,context);
    return application;
  }
 catch (  final IllegalAccessException e) {
    System.err.println("Illegal access to application class " + applicationClass.getName());
    throw e;
  }
catch (  final InstantiationException e) {
    System.err.println("Failed to instantiate application class: " + applicationClass.getName());
    throw e;
  }
}
