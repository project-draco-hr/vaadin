{
  if ((request.getPathInfo() != null) && (request.getPathInfo().length() > 10)) {
    if ((request.getContextPath() != null) && (request.getRequestURI().startsWith("/ITMILL/"))) {
      serveStaticResourcesInITMILL(request.getRequestURI(),response);
      return;
    }
 else     if (request.getRequestURI().startsWith(request.getContextPath() + "/ITMILL/")) {
      serveStaticResourcesInITMILL(request.getRequestURI().substring(request.getContextPath().length()),response);
      return;
    }
  }
  Application application=null;
  try {
    if (ServletFileUpload.isMultipartContent(request)) {
      application=getApplication(request);
      getApplicationManager(application).handleFileUpload(request,response);
      return;
    }
    final WebBrowser browser=WebApplicationContext.getApplicationContext(request.getSession()).getBrowser();
    browser.updateBrowserProperties(request);
    application=getApplication(request);
    ((WebApplicationContext)application.getContext()).startTransaction(application,request);
    DownloadStream download=null;
    if (request.getPathInfo() != null) {
      String compare=AJAX_UIDL_URI;
      if (applicationRunnerMode) {
        final String[] URIparts=getApplicationRunnerURIs(request);
        final String applicationClassname=URIparts[4];
        compare="/" + applicationClassname + AJAX_UIDL_URI;
      }
      if (request.getPathInfo().startsWith(compare)) {
        getApplicationManager(application).handleUidlRequest(request,response);
        return;
      }
    }
    if (application.isRunning()) {
      download=handleURI(application,request,response);
    }
    if (download == null) {
      response.setHeader("Cache-Control","no-cache");
      response.setHeader("Pragma","no-cache");
      response.setDateHeader("Expires",0);
      Window window=null;
      if (application.isRunning()) {
        window=getApplicationWindow(request,application);
      }
      if (!application.isRunning()) {
        endApplication(request,response,application);
        return;
      }
      if (window.getTerminal() == null) {
        window.setTerminal(browser);
      }
      String themeName=window.getTheme();
      if (request.getParameter("theme") != null) {
        themeName=request.getParameter("theme");
      }
      if (handleResourceRequest(request,response,themeName)) {
        return;
      }
      final Map parameters=request.getParameterMap();
      if (window != null && parameters != null) {
        window.handleParameters(parameters);
      }
      writeAjaxPage(request,response,window,themeName);
    }
    if (download != null) {
      handleDownload(download,request,response);
    }
  }
 catch (  final Throwable e) {
    e.printStackTrace();
    throw new ServletException(e);
  }
 finally {
    if (application != null) {
      ((WebApplicationContext)application.getContext()).endTransaction(application,request);
    }
  }
}
