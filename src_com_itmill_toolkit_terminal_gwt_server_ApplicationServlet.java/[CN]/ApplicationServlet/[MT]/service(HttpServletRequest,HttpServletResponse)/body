{
  if (request.getPathInfo() != null) {
    if (applicationRunnerMode && (request.getPathInfo().indexOf("/",1) != -1)) {
      String resourceUrl=request.getPathInfo().substring(request.getPathInfo().indexOf('/',1));
      if (resourceUrl.startsWith("/ITMILL/")) {
        serveStaticResourcesInITMILL(resourceUrl,response);
        return;
      }
    }
 else     if (request.getPathInfo().startsWith("/ITMILL/")) {
      serveStaticResourcesInITMILL(request.getPathInfo(),response);
      return;
    }
  }
  Application application=null;
  try {
    if (ServletFileUpload.isMultipartContent(request)) {
      application=getApplication(request);
      getApplicationManager(application).handleFileUpload(request,response);
      return;
    }
    WebBrowser browser=WebApplicationContext.getApplicationContext(request.getSession()).getBrowser();
    browser.updateBrowserProperties(request);
    application=getApplication(request);
synchronized (applicationToLastRequestDate) {
      applicationToLastRequestDate.put(application,new Date());
    }
    ((WebApplicationContext)application.getContext()).startTransaction(application,request);
    DownloadStream download=null;
    String resourceId=request.getPathInfo();
    if (resourceId != null) {
      if (applicationRunnerMode) {
        if (resourceId.indexOf("/",1) != -1) {
          String resourceUrl=resourceId.substring(resourceId.indexOf('/',1));
          if (resourceId != null && (resourceUrl.startsWith(AJAX_UIDL_URI))) {
            getApplicationManager(application).handleUidlRequest(request,response);
            return;
          }
        }
      }
 else {
        if (resourceId.startsWith(AJAX_UIDL_URI)) {
          getApplicationManager(application).handleUidlRequest(request,response);
          return;
        }
      }
    }
    if (application.isRunning()) {
      download=handleURI(application,request,response);
    }
    if (download == null) {
      response.setHeader("Cache-Control","no-cache");
      response.setHeader("Pragma","no-cache");
      response.setDateHeader("Expires",0);
      Window window=null;
      if (application.isRunning()) {
        window=getApplicationWindow(request,application);
      }
      if (!application.isRunning()) {
        endApplication(request,response,application);
        return;
      }
      if (window.getTerminal() == null) {
        window.setTerminal(browser);
      }
      String themeName=window.getTheme();
      if (request.getParameter("theme") != null) {
        themeName=request.getParameter("theme");
      }
      if (handleResourceRequest(request,response,themeName)) {
        return;
      }
      Map parameters=request.getParameterMap();
      if (window != null && parameters != null) {
        window.handleParameters(parameters);
      }
      writeAjaxPage(request,response,window,themeName);
    }
    if (download != null) {
      handleDownload(download,request,response);
    }
  }
 catch (  Throwable e) {
    e.printStackTrace();
    throw new ServletException(e);
  }
 finally {
    if (application != null) {
      ((WebApplicationContext)application.getContext()).endTransaction(application,request);
    }
  }
}
