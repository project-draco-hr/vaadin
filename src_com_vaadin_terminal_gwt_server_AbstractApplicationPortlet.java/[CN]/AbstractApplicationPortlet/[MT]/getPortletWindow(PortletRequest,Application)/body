{
  PortletMode mode=request.getPortletMode();
  if (PortletMode.VIEW.equals(mode)) {
    return application.getMainWindow();
  }
 else {
    Window window=application.getWindow(mode.toString());
    if (window != null) {
      return window;
    }
  }
  return application.getMainWindow();
}
