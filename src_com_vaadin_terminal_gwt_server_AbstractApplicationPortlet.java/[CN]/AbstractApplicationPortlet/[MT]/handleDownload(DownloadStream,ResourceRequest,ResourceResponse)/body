{
  if (stream.getParameter("Location") != null) {
    response.setProperty(ResourceResponse.HTTP_STATUS_CODE,Integer.toString(HttpServletResponse.SC_MOVED_TEMPORARILY));
    response.setProperty("Location",stream.getParameter("Location"));
    return;
  }
  final InputStream data=stream.getStream();
  if (data != null) {
    OutputStream out=null;
    try {
      response.setContentType(stream.getContentType());
      final long cacheTime=stream.getCacheTime();
      if (cacheTime <= 0) {
        response.setProperty("Cache-Control","no-cache");
        response.setProperty("Pragma","no-cache");
        response.setProperty("Expires","0");
      }
 else {
        response.setProperty("Cache-Control","max-age=" + cacheTime / 1000);
        response.setProperty("Expires","" + System.currentTimeMillis() + cacheTime);
        response.setProperty("Pragma","cache");
      }
      final Iterator<String> i=stream.getParameterNames();
      if (i != null) {
        while (i.hasNext()) {
          final String param=i.next();
          response.setProperty(param,stream.getParameter(param));
        }
      }
      String contentDispositionValue=stream.getParameter("Content-Disposition");
      if (contentDispositionValue == null) {
        contentDispositionValue="filename=\"" + stream.getFileName() + "\"";
        response.setProperty("Content-Disposition",contentDispositionValue);
      }
      int bufferSize=stream.getBufferSize();
      if (bufferSize <= 0 || bufferSize > MAX_BUFFER_SIZE) {
        bufferSize=DEFAULT_BUFFER_SIZE;
      }
      final byte[] buffer=new byte[bufferSize];
      int bytesRead=0;
      out=response.getPortletOutputStream();
      while ((bytesRead=data.read(buffer)) > 0) {
        out.write(buffer,0,bytesRead);
        out.flush();
      }
      out.close();
    }
  finally {
      AbstractCommunicationManager.tryToCloseStream(data);
      AbstractCommunicationManager.tryToCloseStream(out);
    }
  }
}
