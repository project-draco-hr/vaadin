{
  VaadinSession session=createVaadinSession(request);
  VaadinSession.setCurrent(session);
  session.storeInSession(this,request.getWrappedSession());
  Locale locale=request.getLocale();
  session.setLocale(locale);
  session.setConfiguration(getDeploymentConfiguration());
  session.setCommunicationManager(new LegacyCommunicationManager(session));
  ServletPortletHelper.initDefaultUIProvider(session,this);
  onVaadinSessionStarted(request,session);
  return session;
}
