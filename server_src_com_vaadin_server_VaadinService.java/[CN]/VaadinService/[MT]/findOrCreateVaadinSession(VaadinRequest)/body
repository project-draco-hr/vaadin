{
  boolean requestCanCreateSession=requestCanCreateSession(request);
  VaadinServiceSession session=getExistingSession(request,requestCanCreateSession);
  if (session != null) {
    final boolean restartApplication=(request.getParameter(URL_PARAMETER_RESTART_APPLICATION) != null);
    final boolean closeApplication=(request.getParameter(URL_PARAMETER_CLOSE_APPLICATION) != null);
    if (restartApplication) {
      closeSession(session,request.getWrappedSession(false));
      return createAndRegisterSession(request);
    }
 else     if (closeApplication) {
      closeSession(session,request.getWrappedSession(false));
      return null;
    }
 else {
      return session;
    }
  }
  if (requestCanCreateSession) {
    return createAndRegisterSession(request);
  }
 else {
    throw new SessionExpiredException();
  }
}
