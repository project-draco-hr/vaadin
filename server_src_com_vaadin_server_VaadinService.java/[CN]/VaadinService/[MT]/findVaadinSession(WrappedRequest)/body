{
  boolean requestCanCreateApplication=requestCanCreateSession(request);
  VaadinSession session=getExistingSession(request,requestCanCreateApplication);
  if (session != null) {
    final boolean restartApplication=(request.getParameter(URL_PARAMETER_RESTART_APPLICATION) != null);
    final boolean closeApplication=(request.getParameter(URL_PARAMETER_CLOSE_APPLICATION) != null);
    if (restartApplication) {
      closeApplication(session,request.getWrappedSession(false));
      return createAndRegisterApplication(request);
    }
 else     if (closeApplication) {
      closeApplication(session,request.getWrappedSession(false));
      return null;
    }
 else {
      return session;
    }
  }
  if (requestCanCreateApplication) {
    return createAndRegisterApplication(request);
  }
 else {
    throw new SessionExpiredException();
  }
}
