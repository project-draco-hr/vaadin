{
  WrappedHttpServletRequest request=WrappedHttpServletRequest.cast(wrappedRequest);
  if (shouldCreateApplication(request)) {
    VaadinSession.setCurrent(session);
    session.getBrowser().updateRequestDetails(request);
    LegacyApplication legacyApplication=getNewApplication(request);
    legacyApplication.doInit();
    session.addUIProvider(legacyApplication);
  }
}
