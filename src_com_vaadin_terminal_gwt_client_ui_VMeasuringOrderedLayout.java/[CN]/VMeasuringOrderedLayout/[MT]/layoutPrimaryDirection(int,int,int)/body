{
  int actuallyAllocated=0;
  double totalExpand=0;
  int childCount=0;
  for (  Widget child : this) {
    if (child instanceof VCaption) {
      continue;
    }
    childCount++;
    VLayoutSlot slot=getSlotForChild(child);
    totalExpand+=slot.getExpandRatio();
    if (!slot.isRelativeInDirection(isVertical)) {
      actuallyAllocated+=slot.getUsedSizeInDirection(isVertical);
    }
  }
  actuallyAllocated+=spacingSize * (childCount - 1);
  if (allocatedSize == -1) {
    allocatedSize=actuallyAllocated;
  }
  double unallocatedSpace=Math.max(0,allocatedSize - actuallyAllocated);
  double currentLocation=startPadding;
  for (  Widget child : this) {
    if (child instanceof VCaption) {
      continue;
    }
    VLayoutSlot slot=getSlotForChild(child);
    double childExpandRatio;
    if (totalExpand == 0) {
      childExpandRatio=1d / childCount;
    }
 else {
      childExpandRatio=slot.getExpandRatio() / totalExpand;
    }
    double extraPixels=unallocatedSpace * childExpandRatio;
    double endLocation=currentLocation + extraPixels;
    if (!slot.isRelativeInDirection(isVertical)) {
      endLocation+=slot.getUsedSizeInDirection(isVertical);
    }
    double roundedLocation=Math.round(currentLocation);
    double roundedSpace=Math.round(endLocation) - roundedLocation;
    slot.positionInDirection(roundedLocation,roundedSpace,isVertical);
    currentLocation=endLocation + spacingSize;
  }
  return allocatedSize;
}
