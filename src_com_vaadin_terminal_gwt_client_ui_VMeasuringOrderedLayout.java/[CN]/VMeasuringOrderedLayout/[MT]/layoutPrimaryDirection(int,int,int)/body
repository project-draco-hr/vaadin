{
  int actuallyAllocated=0;
  double totalExpand=0;
  int childCount=0;
  for (  Widget child : this) {
    if (child instanceof VCaption) {
      continue;
    }
    childCount++;
    VLayoutSlot slot=getSlotForChild(child);
    totalExpand+=slot.getExpandRatio();
    if (!slot.isRelativeInDirection(isVertical)) {
      actuallyAllocated+=slot.getUsedSizeInDirection(isVertical);
    }
  }
  actuallyAllocated+=spacingSize * (childCount - 1);
  if (allocatedSize == -1) {
    allocatedSize=actuallyAllocated;
  }
  double unallocatedSpace=Math.max(0,allocatedSize - actuallyAllocated);
  double currentLocation=startPadding;
  for (  Widget child : this) {
    if (child instanceof VCaption) {
      continue;
    }
    VLayoutSlot slot=getSlotForChild(child);
    double childExpandRatio;
    if (totalExpand == 0) {
      childExpandRatio=1d / childCount;
    }
 else {
      childExpandRatio=slot.getExpandRatio() / totalExpand;
    }
    double extraPixels=unallocatedSpace * childExpandRatio;
    double allocatedSpace=extraPixels;
    if (!slot.isRelativeInDirection(isVertical)) {
      allocatedSpace+=slot.getUsedSizeInDirection(isVertical);
    }
    slot.positionInDirection(currentLocation,allocatedSpace,isVertical);
    currentLocation+=allocatedSpace + spacingSize;
  }
  return allocatedSize;
}
