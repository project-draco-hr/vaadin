{
  AtmosphereRequest req=resource.getRequest();
  VaadinServletRequest vaadinRequest=new VaadinServletRequest(req,service);
  VaadinSession session=null;
  service.requestStart(vaadinRequest,null);
  try {
    try {
      session=service.findVaadinSession(vaadinRequest);
    }
 catch (    ServiceException e) {
      getLogger().log(Level.SEVERE,"Could not get session. This should never happen",e);
      return;
    }
catch (    SessionExpiredException e) {
      SystemMessages msg=service.getSystemMessages(ServletPortletHelper.findLocale(null,null,vaadinRequest),vaadinRequest);
      sendNotificationAndDisconnect(resource,VaadinService.createCriticalNotificationJSON(msg.getSessionExpiredCaption(),msg.getSessionExpiredMessage(),null,msg.getSessionExpiredURL()));
      return;
    }
    UI ui=null;
    session.lock();
    try {
      VaadinSession.setCurrent(session);
      ui=service.findUI(vaadinRequest);
      if (ui == null) {
        sendNotificationAndDisconnect(resource,UidlRequestHandler.getUINotFoundErrorJSON(service,vaadinRequest));
      }
 else {
        callback.run(resource,ui);
      }
    }
 catch (    final IOException e) {
      callErrorHandler(session,e);
    }
catch (    final Exception e) {
      SystemMessages msg=service.getSystemMessages(ServletPortletHelper.findLocale(null,null,vaadinRequest),vaadinRequest);
      AtmosphereResource errorResource=resource;
      if (ui != null && ui.getPushConnection() != null) {
        errorResource=((AtmospherePushConnection)ui.getPushConnection()).getResource();
      }
      sendNotificationAndDisconnect(errorResource,VaadinService.createCriticalNotificationJSON(msg.getInternalErrorCaption(),msg.getInternalErrorMessage(),null,msg.getInternalErrorURL()));
      callErrorHandler(session,e);
    }
 finally {
      try {
        session.unlock();
      }
 catch (      Exception e) {
        getLogger().log(Level.WARNING,"Error while unlocking session",e);
      }
    }
  }
  finally {
    try {
      service.requestEnd(vaadinRequest,null,session);
    }
 catch (    Exception e) {
      getLogger().log(Level.WARNING,"Error while ending request",e);
    }
  }
}
