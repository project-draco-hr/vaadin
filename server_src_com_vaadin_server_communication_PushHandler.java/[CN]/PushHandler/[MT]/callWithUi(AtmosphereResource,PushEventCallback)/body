{
  AtmosphereRequest req=resource.getRequest();
  VaadinServletRequest vaadinRequest=new VaadinServletRequest(req,service);
  VaadinSession session=null;
  service.requestStart(vaadinRequest,null);
  try {
    try {
      session=service.findVaadinSession(vaadinRequest);
    }
 catch (    ServiceException e) {
      getLogger().log(Level.SEVERE,"Could not get session. This should never happen",e);
      return;
    }
catch (    SessionExpiredException e) {
      SystemMessages msg=service.getSystemMessages(ServletPortletHelper.findLocale(null,null,vaadinRequest),vaadinRequest);
      sendNotificationAndDisconnect(resource,VaadinService.createCriticalNotificationJSON(msg.getSessionExpiredCaption(),msg.getSessionExpiredMessage(),null,msg.getSessionExpiredURL()));
      return;
    }
    session.lock();
    try {
      VaadinSession.setCurrent(session);
      final UI ui=service.findUI(vaadinRequest);
      if (ui == null) {
        sendNotificationAndDisconnect(resource,UidlRequestHandler.getUINotFoundErrorJSON(service,vaadinRequest));
      }
 else {
        callback.run(resource,ui);
      }
    }
 catch (    IOException e) {
      getLogger().log(Level.WARNING,"Error writing a push response",e);
    }
 finally {
      session.unlock();
    }
  }
  finally {
    service.requestEnd(vaadinRequest,null,session);
  }
}
