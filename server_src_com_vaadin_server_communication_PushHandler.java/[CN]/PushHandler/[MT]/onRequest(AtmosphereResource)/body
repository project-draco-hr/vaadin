{
  AtmosphereRequest req=resource.getRequest();
  VaadinRequest vaadinRequest=getVaadinRequest(req);
  VaadinSession session;
  try {
    session=service.findVaadinSession(vaadinRequest);
  }
 catch (  ServiceException e) {
    e.printStackTrace();
    return;
  }
catch (  SessionExpiredException e) {
    e.printStackTrace();
    return;
  }
  session.lock();
  try {
    UI ui=service.findUI(vaadinRequest);
    if (ui == null) {
      throw new RuntimeException("UI not found!");
    }
    PushConnection connection=ui.getPushConnection();
    if (req.getMethod().equalsIgnoreCase("GET")) {
      getLogger().log(Level.FINER,"New push connection with transport {}",resource.transport());
      resource.suspend();
      connection.connect(resource);
    }
 else     if (req.getMethod().equalsIgnoreCase("POST")) {
      new ServerRpcHandler().handleRpc(ui,req.getReader(),vaadinRequest);
      connection.push(false);
    }
  }
 catch (  InvalidUIDLSecurityKeyException e) {
    e.printStackTrace();
  }
catch (  JSONException e) {
    e.printStackTrace();
  }
catch (  IOException e) {
    e.printStackTrace();
  }
 finally {
    session.unlock();
  }
}
