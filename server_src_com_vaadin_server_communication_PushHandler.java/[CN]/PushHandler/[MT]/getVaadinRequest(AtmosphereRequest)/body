{
  while (req.getRequest() instanceof AtmosphereRequest) {
    req=(AtmosphereRequest)req.getRequest();
  }
  if (req.getRequest() instanceof VaadinRequest) {
    return (VaadinRequest)req.getRequest();
  }
 else {
    throw new IllegalArgumentException("Request does not wrap VaadinRequest");
  }
}
