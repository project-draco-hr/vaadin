{
  if (!containsId(itemId)) {
    return false;
  }
  final Object oldParentId=parent.get(itemId);
  if ((newParentId == null && oldParentId == null) || ((newParentId != null) && newParentId.equals(oldParentId))) {
    return true;
  }
  if (newParentId == null) {
    final LinkedList<Object> l=children.get(itemId);
    if (l != null) {
      l.remove(itemId);
      if (l.isEmpty()) {
        children.remove(itemId);
      }
      if (filteredChildren != null) {
        LinkedList<Object> f=filteredChildren.get(itemId);
        if (f != null) {
          f.remove(itemId);
          if (f.isEmpty()) {
            filteredChildren.remove(f);
          }
        }
      }
    }
    roots.add(itemId);
    if (filteredRoots != null) {
      if (passesFilters(itemId)) {
        filteredRoots.add(itemId);
      }
    }
    parent.remove(itemId);
    fireContentsChange(-1);
    return true;
  }
  if (!containsId(newParentId) || noChildrenAllowed.contains(newParentId)) {
    return false;
  }
  Object o=newParentId;
  while (o != null && !o.equals(itemId)) {
    o=parent.get(o);
  }
  if (o != null) {
    return false;
  }
  parent.put(itemId,newParentId);
  LinkedList<Object> pcl=children.get(newParentId);
  if (pcl == null) {
    pcl=new LinkedList<Object>();
    children.put(newParentId,pcl);
  }
  pcl.add(itemId);
  if (filteredChildren != null) {
    LinkedList<Object> f=filteredChildren.get(newParentId);
    if (f == null) {
      f=new LinkedList<Object>();
      filteredChildren.put(newParentId,f);
    }
  }
  if (oldParentId == null) {
    roots.remove(itemId);
  }
 else {
    final LinkedList<Object> l=children.get(oldParentId);
    if (l != null) {
      l.remove(itemId);
      if (l.isEmpty()) {
        children.remove(oldParentId);
      }
    }
    if (filteredChildren != null) {
      LinkedList<Object> f=filteredChildren.get(oldParentId);
      if (f != null) {
        f.remove(itemId);
        if (f.isEmpty()) {
          filteredChildren.remove(oldParentId);
        }
      }
    }
  }
  fireContentsChange(-1);
  return true;
}
