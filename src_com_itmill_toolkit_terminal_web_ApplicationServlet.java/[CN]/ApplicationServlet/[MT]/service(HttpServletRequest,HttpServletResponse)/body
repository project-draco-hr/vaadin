{
  UIDLTransformer transformer=null;
  HttpVariableMap variableMap=null;
  OutputStream out=response.getOutputStream();
  HashSet currentlyDirtyWindowsForThisApplication=new HashSet();
  Application application=null;
  try {
    if (handleResourceRequest(request,response))     return;
    if (handleServerCommands(request,response))     return;
    application=getApplication(request);
    if (application == null)     application=createApplication(request);
    applicationToLastRequestDate.put(application,new Date());
    ((WebApplicationContext)application.getContext()).startTransaction(application,request);
    DownloadStream download=null;
synchronized (application) {
      String resourceId=request.getPathInfo();
      if (resourceId != null && resourceId.startsWith(AJAX_UIDL_URI)) {
        getApplicationManager(application).handleUidlRequest(request,response);
        return;
      }
      variableMap=getVariableMap(application,request);
      if (variableMap == null)       return;
      Map unhandledParameters=variableMap.handleVariables(request,application);
      WebBrowserProbe.handleProbeRequest(request,unhandledParameters);
      if (application.isRunning())       download=handleURI(application,request,response);
      if (download == null) {
        response.setHeader("Cache-Control","no-cache");
        response.setHeader("Pragma","no-cache");
        response.setDateHeader("Expires",0);
        Window window=null;
        if (application.isRunning())         window=getApplicationWindow(request,application,unhandledParameters);
        if (window != null && unhandledParameters != null && !unhandledParameters.isEmpty()) {
          try {
            window.handleParameters(unhandledParameters);
          }
 catch (          Throwable t) {
            application.terminalError(new ParameterHandlerErrorImpl(window,t));
          }
        }
        if (!application.isRunning()) {
          endApplication(request,response,application);
          return;
        }
        if (window == null) {
          response.setContentType("text/html");
          BufferedWriter page=new BufferedWriter(new OutputStreamWriter(out));
          page.write("<html><head><script>");
          page.write(ThemeFunctionLibrary.generateWindowScript(null,application,this,WebBrowserProbe.getTerminalType(request.getSession())));
          page.write("</script></head><body>");
          page.write("The requested window has been removed from application.");
          page.write("</body></html>");
          page.close();
          return;
        }
        WebBrowser terminalType=(WebBrowser)window.getTerminal();
        if (terminalType == null) {
          terminalType=WebBrowserProbe.getTerminalType(request.getSession());
          window.setTerminal(terminalType);
        }
        String themeName=window.getTheme() != null ? window.getTheme() : DEFAULT_THEME;
        if (unhandledParameters.get("theme") != null) {
          themeName=(String)((Object[])unhandledParameters.get("theme"))[0];
        }
        Theme theme=themeSource.getThemeByName(themeName);
        if (theme == null)         throw new ServletException("Theme (named '" + themeName + "') can not be found");
        String renderingMode=theme.getPreferredMode(terminalType,themeSource);
        if (unhandledParameters.get("renderingMode") != null)         renderingMode=(String)((Object[])unhandledParameters.get("renderingMode"))[0];
        if (Theme.MODE_UIDL.equals(renderingMode) && !(window instanceof DebugWindow)) {
          response.setContentType("text/html");
          BufferedWriter page=new BufferedWriter(new OutputStreamWriter(out));
          page.write("<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" " + "\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n");
          page.write("<html><head>\n<title>" + window.getCaption() + "</title>\n");
          Theme t=theme;
          Vector themes=new Vector();
          themes.add(t);
          while (t.getParent() != null) {
            String parentName=t.getParent();
            t=themeSource.getThemeByName(parentName);
            themes.add(t);
          }
          for (int k=themes.size() - 1; k >= 0; k--) {
            t=(Theme)themes.get(k);
            Collection files=t.getFileNames(terminalType,Theme.MODE_UIDL);
            for (Iterator i=files.iterator(); i.hasNext(); ) {
              String file=(String)i.next();
              if (file.endsWith(".css"))               page.write("<link rel=\"stylesheet\" href=\"" + getResourceLocation(t.getName(),new ThemeResource(file)) + "\" type=\"text/css\" />\n");
 else               if (file.endsWith(".js"))               page.write("<script src=\"" + getResourceLocation(t.getName(),new ThemeResource(file)) + "\" type=\"text/javascript\"></script>\n");
            }
          }
          page.write("</head><body>\n");
          page.write("<div id=\"ajax-wait\"><div>Loading...</div></div>\n");
          page.write("<div id=\"ajax-window\"></div>\n");
          page.write("<script language=\"JavaScript\">\n");
          String appUrl=getApplicationUrl(request).toString();
          page.write("var client = new itmill.Client(" + "document.getElementById('ajax-window')," + "\"" + appUrl + (appUrl.endsWith("/") ? "" : "/")+ "UIDL/"+ "\",\""+ resourcePath+ ((Theme)themes.get(themes.size() - 1)).getName()+ "/"+ "client/\",document.getElementById('ajax-wait'));\n");
          for (int k=themes.size() - 1; k >= 0; k--) {
            t=(Theme)themes.get(k);
            String themeObjName="itmill.themes." + t.getName().substring(0,1).toUpperCase() + t.getName().substring(1);
            page.write(" (new " + themeObjName + "(\""+ resourcePath+ ((Theme)themes.get(k)).getName()+ "/\")).registerTo(client);\n");
          }
          if (isDebugMode(unhandledParameters))           page.write("client.debugEnabled =true;\n");
          page.write("client.start();\n");
          page.write("</script>\n");
          page.write("</body></html>\n");
          page.close();
          return;
        }
        if (!Theme.MODE_XSLT.equals(renderingMode) && !(window instanceof DebugWindow)) {
          response.setContentType("text/html");
          BufferedWriter page=new BufferedWriter(new OutputStreamWriter(out));
          page.write("<html><head></head><body>");
          page.write("Unsupported browser.");
          page.write("</body></html>");
          page.close();
          return;
        }
        UIDLTransformerType transformerType=new UIDLTransformerType(terminalType,theme);
        transformer=this.transformerFactory.getTransformer(transformerType);
        response.setContentType(terminalType.getContentType());
        WebPaintTarget paintTarget=transformer.getPaintTarget(variableMap);
        DebugWindow debugWindow=(DebugWindow)application.getWindow(DebugWindow.WINDOW_NAME);
        if (debugWindow != null && debugWindow != window) {
          debugWindow.setWindowUIDL(window,"Painting...");
        }
        window.paint(paintTarget);
        paintTarget.close();
        Collection dirtyWindows=(Collection)applicationToDirtyWindowSetMap.get(application);
        if (dirtyWindows == null) {
          dirtyWindows=new HashSet();
          applicationToDirtyWindowSetMap.put(application,dirtyWindows);
        }
        currentlyDirtyWindowsForThisApplication.addAll(dirtyWindows);
        windowPainted(application,window);
        if (debugWindow != null && debugWindow != window) {
          debugWindow.setWindowUIDL(window,paintTarget.getUIDL());
        }
        ThemeFunctionLibrary.setState(application,window,transformerType.getWebBrowser(),request.getSession(),this,transformerType.getTheme().getName());
      }
    }
    if (download == null) {
      transformer.transform(out);
    }
 else {
      handleDownload(download,request,response);
    }
  }
 catch (  UIDLTransformerException te) {
    try {
      response.setContentType("text/html");
      BufferedWriter err=new BufferedWriter(new OutputStreamWriter(out));
      err.write("<html><head><title>Application Internal Error</title></head><body>");
      err.write("<h1>" + te.getMessage() + "</h1>");
      err.write(te.getHTMLDescription());
      err.write("</body></html>");
      err.close();
    }
 catch (    Throwable t) {
      Log.except("Failed to write error page: " + t + ". Original exception was: ",te);
    }
    Application currentApplication=getApplication(request);
    for (Iterator iter=currentlyDirtyWindowsForThisApplication.iterator(); iter.hasNext(); ) {
      Window dirtyWindow=(Window)iter.next();
      addDirtyWindow(currentApplication,dirtyWindow);
    }
  }
catch (  Throwable e) {
    throw new ServletException(e);
  }
 finally {
    if (transformer != null)     transformerFactory.releaseTransformer(transformer);
    if (application != null)     ((WebApplicationContext)application.getContext()).endTransaction(application,request);
    ThemeFunctionLibrary.cleanState();
  }
}
