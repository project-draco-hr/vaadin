{
  UI uI=connector.getUI();
  ConnectorTracker connectorTracker=uI.getConnectorTracker();
  Class<? extends SharedState> stateType=connector.getStateType();
  JsonValue diffState=connectorTracker.getDiffState(connector);
  boolean supportsDiffState=!JavaScriptConnectorState.class.isAssignableFrom(stateType);
  if (diffState == null && supportsDiffState) {
    diffState=referenceDiffStates.get(stateType);
    if (diffState == null) {
      diffState=createReferenceDiffStateState(stateType);
      referenceDiffStates.put(stateType,diffState);
    }
  }
  EncodeResult encodeResult=JsonCodec.encode(state,diffState,stateType,uI.getConnectorTracker());
  if (supportsDiffState) {
    connectorTracker.setDiffState(connector,(JsonObject)encodeResult.getEncodedValue());
  }
  return (JsonObject)encodeResult.getDiff();
}
