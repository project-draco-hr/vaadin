{
  debug("VFS.SP: setPosition(" + offsetWidth + ", "+ offsetHeight+ ")");
  int top=topPosition;
  int left=getPopupLeft();
  menu.setHeight("");
  if (currentPage > 0 && !hasNextPage()) {
    menu.fixHeightTo(pageLength);
  }
  final int desiredHeight=offsetHeight=getOffsetHeight();
  final int desiredWidth=getMainWidth();
  debug("VFS.SP:     desired[" + desiredWidth + ", "+ desiredHeight+ "]");
  Element menuFirstChild=menu.getElement().getFirstChildElement();
  final int naturalMenuWidth=WidgetUtil.getRequiredWidth(menuFirstChild);
  if (popupOuterPadding == -1) {
    popupOuterPadding=WidgetUtil.measureHorizontalPaddingAndBorder(getElement(),2);
  }
  if (naturalMenuWidth < desiredWidth) {
    menu.setWidth((desiredWidth - popupOuterPadding) + "px");
    menuFirstChild.getStyle().setWidth(100,Unit.PCT);
  }
  if (BrowserInfo.get().isIE()) {
    int naturalMenuOuterWidth=naturalMenuWidth + getMarginBorderPaddingWidth(menu.getElement());
    int rootWidth=Math.max(desiredWidth - popupOuterPadding,naturalMenuOuterWidth);
    getContainerElement().getStyle().setWidth(rootWidth,Unit.PX);
  }
  final int vfsHeight=VFilterSelect.this.getOffsetHeight();
  final int spaceAvailableAbove=top - vfsHeight;
  final int spaceAvailableBelow=Window.getClientHeight() - top;
  if (spaceAvailableBelow < offsetHeight && spaceAvailableBelow < spaceAvailableAbove) {
    top-=offsetHeight + vfsHeight;
    if (top < 0) {
      offsetHeight+=top;
      top=0;
    }
  }
 else {
    offsetHeight=Math.min(offsetHeight,spaceAvailableBelow);
  }
  offsetWidth=menuFirstChild.getOffsetWidth();
  if (offsetHeight < desiredHeight) {
    int menuHeight=offsetHeight;
    if (isPagingEnabled) {
      menuHeight-=up.getOffsetHeight() + down.getOffsetHeight() + status.getOffsetHeight();
    }
 else {
      final ComputedStyle s=new ComputedStyle(menu.getElement());
      menuHeight-=s.getIntProperty("marginBottom") + s.getIntProperty("marginTop");
    }
    int menuElementHeight=menu.getItemOffsetHeight();
    if (menuHeight < menuElementHeight) {
      menuHeight=menuElementHeight;
    }
    menu.setHeight(menuHeight + "px");
    final int naturalMenuWidthPlusScrollBar=naturalMenuWidth + WidgetUtil.getNativeScrollbarSize();
    if (offsetWidth < naturalMenuWidthPlusScrollBar) {
      menu.setWidth(naturalMenuWidthPlusScrollBar + "px");
    }
  }
  if (offsetWidth + left > Window.getClientWidth()) {
    left=VFilterSelect.this.getAbsoluteLeft() + VFilterSelect.this.getOffsetWidth() - offsetWidth;
    if (left < 0) {
      left=0;
      menu.setWidth(Window.getClientWidth() + "px");
    }
  }
  setPopupPosition(left,top);
  menu.scrollSelectionIntoView();
}
