{
  debug("VFS.SP: setPosition()");
  int top=getPopupTop();
  int left=getPopupLeft();
  if (desiredHeight < 0) {
    desiredHeight=offsetHeight;
  }
  final int desiredWidth=getMainWidth();
  Element menuFirstChild=menu.getElement().getFirstChildElement();
  int naturalMenuWidth=menuFirstChild.getOffsetWidth();
  if (popupOuterPadding == -1) {
    popupOuterPadding=Util.measureHorizontalPaddingAndBorder(getElement(),2);
  }
  if (naturalMenuWidth < desiredWidth) {
    menu.setWidth((desiredWidth - popupOuterPadding) + "px");
    menuFirstChild.getStyle().setWidth(100,Unit.PCT);
    naturalMenuWidth=desiredWidth;
  }
  if (BrowserInfo.get().isIE()) {
    int rootWidth=naturalMenuWidth - popupOuterPadding;
    getContainerElement().getStyle().setWidth(rootWidth,Unit.PX);
  }
  final int spaceAvailableBelow=Window.getClientHeight() - (top - Window.getScrollTop());
  final int spaceAvailableAbove=top - Window.getScrollTop() - VFilterSelect.this.getOffsetHeight();
  if (spaceAvailableBelow < desiredHeight && spaceAvailableBelow < spaceAvailableAbove) {
    top-=desiredHeight + VFilterSelect.this.getOffsetHeight();
    offsetHeight=desiredHeight;
    if (top < 0) {
      offsetHeight+=top;
      top=0;
    }
  }
 else {
    int topMargin=(top - topPosition);
    top-=topMargin;
    offsetHeight=Math.min(desiredHeight,spaceAvailableBelow);
  }
  if (getOffsetHeight() != offsetHeight) {
    int menuHeight=offsetHeight - up.getOffsetHeight() - down.getOffsetHeight()- status.getOffsetHeight();
    menu.setHeight(menuHeight + "px");
    getContainerElement().getStyle().setHeight(offsetHeight,Unit.PX);
  }
  offsetWidth=menuFirstChild.getOffsetWidth();
  if (offsetWidth + getPopupLeft() > Window.getClientWidth() + Window.getScrollLeft()) {
    left=VFilterSelect.this.getAbsoluteLeft() + VFilterSelect.this.getOffsetWidth() + Window.getScrollLeft() - offsetWidth;
    if (left < 0) {
      left=0;
    }
  }
  setPopupPosition(left,top);
}
