{
  Widget widget=getWidget();
  if (captionText != null || iconUrl != null || error != null || required) {
    if (caption == null) {
      caption=DOM.createDiv();
      captionWrap=DOM.createDiv();
      captionWrap.addClassName(StyleConstants.UI_WIDGET);
      captionWrap.addClassName("v-has-caption");
      getElement().appendChild(captionWrap);
      orphan(widget);
      captionWrap.appendChild(widget.getElement());
      adopt(widget);
    }
  }
 else   if (caption != null) {
    orphan(widget);
    getElement().appendChild(widget.getElement());
    adopt(widget);
    captionWrap.removeFromParent();
    caption=null;
    captionWrap=null;
  }
  if (captionText != null) {
    if (this.captionText == null) {
      this.captionText=DOM.createSpan();
      this.captionText.addClassName("v-captiontext");
      caption.appendChild(this.captionText);
    }
    if (captionText.trim().equals("")) {
      this.captionText.setInnerHTML("&nbsp;");
    }
 else {
      this.captionText.setInnerText(captionText);
    }
  }
 else   if (this.captionText != null) {
    this.captionText.removeFromParent();
    this.captionText=null;
  }
  if (iconUrl != null) {
    if (icon == null) {
      icon=new Icon();
      caption.insertFirst(icon.getElement());
    }
    icon.setUri(iconUrl);
  }
 else   if (icon != null) {
    icon.getElement().removeFromParent();
    icon=null;
  }
  if (required) {
    if (requiredIcon == null) {
      requiredIcon=DOM.createSpan();
      requiredIcon.setInnerHTML("*");
      requiredIcon.setClassName("v-required-field-indicator");
      Roles.getTextboxRole().setAriaHiddenState(requiredIcon,true);
    }
    caption.appendChild(requiredIcon);
  }
 else   if (requiredIcon != null) {
    requiredIcon.removeFromParent();
    requiredIcon=null;
  }
  if (error != null && showError) {
    if (errorIcon == null) {
      errorIcon=DOM.createSpan();
      errorIcon.setClassName("v-errorindicator");
    }
    caption.appendChild(errorIcon);
  }
 else   if (errorIcon != null) {
    errorIcon.removeFromParent();
    errorIcon=null;
  }
  if (caption != null) {
    caption.setClassName("v-caption");
    if (styles != null) {
      for (      String style : styles) {
        caption.addClassName("v-caption-" + style);
      }
    }
    if (enabled) {
      caption.removeClassName("v-disabled");
    }
 else {
      caption.addClassName("v-disabled");
    }
    if (captionText != null || iconUrl != null) {
      setCaptionPosition(CaptionPosition.TOP);
    }
 else {
      setCaptionPosition(CaptionPosition.RIGHT);
    }
  }
}
