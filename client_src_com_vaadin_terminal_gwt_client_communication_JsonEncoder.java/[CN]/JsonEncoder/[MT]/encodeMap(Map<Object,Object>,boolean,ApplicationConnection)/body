{
  if (map.isEmpty()) {
    return new JSONArray();
  }
  Object firstKey=map.keySet().iterator().next();
  if (firstKey instanceof String) {
    return encodeStringMap(map,restrictToInternalTypes,connection);
  }
 else   if (restrictToInternalTypes) {
    throw new IllegalStateException("Only string keys supported for legacy maps");
  }
 else   if (firstKey instanceof Connector) {
    return encodeConenctorMap(map,connection);
  }
 else {
    return encodeObjectMap(map,connection);
  }
}
