{
  long fileSize=0;
  int read=-1;
  byte[] secondLineOfBytes=new byte[blockOfBytes.length];
  int sizeOfSecondArray=0;
  while (true) {
    read=readLine(in,blockOfBytes);
    if (read < 0)     throw new IOException("Stream ended prematurely.");
    if (read < blockOfBytes.length && new String(blockOfBytes,0,read,charEncoding).indexOf(this.strBoundary) != -1) {
      if (sizeOfSecondArray != 0) {
        int actualLength=getLengthMinusEnding(secondLineOfBytes,sizeOfSecondArray);
        if (actualLength > 0 && out != null) {
          out.write(secondLineOfBytes,0,actualLength);
          fileSize+=actualLength;
        }
      }
      break;
    }
 else {
      if (sizeOfSecondArray != 0) {
        out.write(secondLineOfBytes,0,sizeOfSecondArray);
        fileSize+=sizeOfSecondArray;
      }
      if (out != null) {
        System.arraycopy(blockOfBytes,0,secondLineOfBytes,0,read);
        sizeOfSecondArray=read;
      }
    }
  }
  return fileSize;
}
