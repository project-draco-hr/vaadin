{
  AbstractApplicationServletWrapper servletWrapper=new AbstractApplicationServletWrapper(this);
  WrappedHttpServletRequest wrappedRequest=new WrappedHttpServletRequest(request,this);
  WrappedHttpServletResponse wrappedResponse=new WrappedHttpServletResponse(response);
  RequestType requestType=getRequestType(request);
  if (!ensureCookiesEnabled(requestType,request,response)) {
    return;
  }
  if (requestType == RequestType.STATIC_FILE) {
    serveStaticResources(request,response);
    return;
  }
  if (isRepaintAll(request)) {
    checkWidgetsetVersion(request);
  }
  Application application=null;
  boolean transactionStarted=false;
  boolean requestStarted=false;
  try {
    if (requestType == RequestType.UIDL && request.getParameterMap().containsKey(ApplicationConnection.PARAM_UNLOADBURST) && request.getContentLength() < 1 && getExistingApplication(request,false) == null) {
      redirectToApplication(request,response);
      return;
    }
    application=findApplicationInstance(request,requestType);
    if (application == null) {
      return;
    }
    Application.setCurrentApplication(application);
    WebApplicationContext webApplicationContext=getApplicationContext(request.getSession());
    CommunicationManager applicationManager=webApplicationContext.getApplicationManager(application,this);
    webApplicationContext.getBrowser().updateRequestDetails(wrappedRequest);
    if (application instanceof HttpServletRequestListener) {
      ((HttpServletRequestListener)application).onRequestStart(request,response);
      requestStarted=true;
    }
    startApplication(request,application,webApplicationContext);
    webApplicationContext.startTransaction(application,request);
    transactionStarted=true;
    if (requestType == RequestType.FILE_UPLOAD) {
      applicationManager.handleFileUpload(wrappedRequest,wrappedResponse);
      return;
    }
 else     if (requestType == RequestType.UIDL) {
      Root root=application.getRootForRequest(wrappedRequest);
      if (root == null) {
        throw new ServletException(ERROR_NO_WINDOW_FOUND);
      }
      applicationManager.handleUidlRequest(wrappedRequest,wrappedResponse,servletWrapper,root);
      return;
    }
 else     if (requestType == RequestType.BROWSER_DETAILS) {
      applicationManager.handleBrowserDetailsRequest(wrappedRequest,wrappedResponse,application);
      return;
    }
    if (!application.isRunning()) {
      endApplication(request,response,application);
      return;
    }
    if (applicationManager.handleApplicationRequest(wrappedRequest,wrappedResponse)) {
      return;
    }
  }
 catch (  final SessionExpiredException e) {
    handleServiceSessionExpired(request,response);
  }
catch (  final GeneralSecurityException e) {
    handleServiceSecurityException(request,response);
  }
catch (  final Throwable e) {
    handleServiceException(request,response,application,e);
  }
 finally {
    try {
      if (transactionStarted) {
        ((WebApplicationContext)application.getContext()).endTransaction(application,request);
      }
    }
  finally {
      try {
        if (requestStarted) {
          ((HttpServletRequestListener)application).onRequestEnd(request,response);
        }
      }
  finally {
        Root.setCurrentRoot(null);
        Application.setCurrentApplication(null);
      }
    }
  }
}
