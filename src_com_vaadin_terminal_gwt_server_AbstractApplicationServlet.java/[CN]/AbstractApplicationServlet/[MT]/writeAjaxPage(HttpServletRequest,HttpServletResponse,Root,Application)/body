{
  boolean fragment=(request.getAttribute(REQUEST_FRAGMENT) != null);
  if (fragment) {
    request.setAttribute(Application.class.getName(),application);
  }
  final BufferedWriter page=new BufferedWriter(new OutputStreamWriter(response.getOutputStream(),"UTF-8"));
  String title=((root.getCaption() == null) ? "Vaadin 6" : root.getCaption());
  String appUrl=getApplicationUrl(request).getPath();
  if (appUrl.endsWith("/")) {
    appUrl=appUrl.substring(0,appUrl.length() - 1);
  }
  String themeName=getThemeForRoot(request,root);
  String themeUri=getThemeUri(themeName,request);
  if (!fragment) {
    setAjaxPageHeaders(response);
    writeAjaxPageHtmlHeadStart(page,request);
    writeAjaxPageHtmlHeader(page,title,themeUri,request);
    writeAjaxPageHtmlBodyStart(page,request);
  }
  String appId=appUrl;
  if ("".equals(appUrl)) {
    appId="ROOT";
  }
  appId=appId.replaceAll("[^a-zA-Z0-9]","");
  int hashCode=appId.hashCode();
  if (hashCode < 0) {
    hashCode=-hashCode;
  }
  appId=appId + "-" + hashCode;
  writeAjaxPageHtmlVaadinScripts(themeName,application,page,appUrl,themeUri,appId,request);
  String appClass="v-app-" + getApplicationCSSClassName();
  String themeClass="";
  if (themeName != null) {
    themeClass="v-theme-" + themeName.replaceAll("[^a-zA-Z0-9]","");
  }
 else {
    themeClass="v-theme-" + getDefaultTheme().replaceAll("[^a-zA-Z0-9]","");
  }
  String classNames="v-app " + themeClass + " "+ appClass;
  String divStyle=null;
  if (request.getAttribute(REQUEST_APPSTYLE) != null) {
    divStyle="style=\"" + request.getAttribute(REQUEST_APPSTYLE) + "\"";
  }
  writeAjaxPageHtmlMainDiv(page,appId,classNames,divStyle,request);
  if (!fragment) {
    page.write("</body>\n</html>\n");
  }
  page.close();
}
