{
  if (stream.getParameter("Location") != null) {
    response.setStatus(HttpServletResponse.SC_MOVED_TEMPORARILY);
    response.addHeader("Location",stream.getParameter("Location"));
    return;
  }
  final InputStream data=stream.getStream();
  if (data != null) {
    response.setContentType(stream.getContentType());
    final long cacheTime=stream.getCacheTime();
    if (cacheTime <= 0) {
      response.setHeader("Cache-Control","no-cache");
      response.setHeader("Pragma","no-cache");
      response.setDateHeader("Expires",0);
    }
 else {
      response.setHeader("Cache-Control","max-age=" + cacheTime / 1000);
      response.setDateHeader("Expires",System.currentTimeMillis() + cacheTime);
      response.setHeader("Pragma","cache");
    }
    final Iterator<String> i=stream.getParameterNames();
    if (i != null) {
      while (i.hasNext()) {
        final String param=i.next();
        response.setHeader(param,stream.getParameter(param));
      }
    }
    String contentDispositionValue=stream.getParameter("Content-Disposition");
    if (contentDispositionValue == null) {
      contentDispositionValue="filename=\"" + stream.getFileName() + "\"";
      response.setHeader("Content-Disposition",contentDispositionValue);
    }
    int bufferSize=stream.getBufferSize();
    if (bufferSize <= 0 || bufferSize > MAX_BUFFER_SIZE) {
      bufferSize=DEFAULT_BUFFER_SIZE;
    }
    final byte[] buffer=new byte[bufferSize];
    int bytesRead=0;
    final OutputStream out=response.getOutputStream();
    while ((bytesRead=data.read(buffer)) > 0) {
      out.write(buffer,0,bytesRead);
      out.flush();
    }
    out.close();
    data.close();
  }
}
