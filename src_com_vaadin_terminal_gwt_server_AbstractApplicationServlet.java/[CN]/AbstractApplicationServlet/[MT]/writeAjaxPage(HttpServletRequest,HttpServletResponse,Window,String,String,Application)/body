{
  boolean fragment=(request.getAttribute(REQUEST_FRAGMENT) != null);
  if (fragment) {
    request.setAttribute(Application.class.getName(),application);
  }
  final BufferedWriter page=new BufferedWriter(new OutputStreamWriter(response.getOutputStream()));
  String pathInfo=getRequestPathInfo(request);
  if (pathInfo == null) {
    pathInfo="/";
  }
  String title=((window.getCaption() == null) ? "Vaadin 6" : window.getCaption());
  String widgetset=null;
  Object reqParam=request.getAttribute(REQUEST_WIDGETSET);
  try {
    widgetset=(String)reqParam;
  }
 catch (  Exception e) {
    System.err.println("Warning: request param '" + REQUEST_WIDGETSET + "' could not be used (is not a String)"+ e);
  }
  if (widgetset == null) {
    widgetset=getApplicationProperty(PARAMETER_WIDGETSET);
  }
  if (widgetset == null) {
    widgetset=DEFAULT_WIDGETSET;
  }
  String appUrl=getApplicationUrl(request).getPath();
  if (appUrl.endsWith("/")) {
    appUrl=appUrl.substring(0,appUrl.length() - 1);
  }
  final String staticFilesLocation=getStaticFilesLocation(request);
  final String staticFilePath=getApplicationOrSystemProperty(PARAMETER_VAADIN_RESOURCES,staticFilesLocation);
  reqParam=request.getAttribute(REQUEST_VAADIN_WIDGETSET_PATH);
  final String widgetsetFilePath=reqParam instanceof String ? (String)reqParam : staticFilePath;
  String themeBaseUri;
  String themeUri;
  if (themeName != null) {
    themeBaseUri=staticFilePath;
    themeUri=themeBaseUri + "/" + THEME_DIRECTORY_PATH+ themeName;
  }
 else {
    themeBaseUri=defaultThemeUri;
    themeUri=themeBaseUri + "/" + THEME_DIRECTORY_PATH+ getDefaultTheme();
  }
  if (!fragment) {
    response.setHeader("Cache-Control","no-cache");
    response.setHeader("Pragma","no-cache");
    response.setDateHeader("Expires",0);
    response.setContentType("text/html; charset=UTF-8");
    page.write("<!DOCTYPE html PUBLIC \"-//W3C//DTD " + "XHTML 1.0 Transitional//EN\" " + "\"http://www.w3.org/TR/xhtml1/"+ "DTD/xhtml1-transitional.dtd\">\n");
    page.write("<html xmlns=\"http://www.w3.org/1999/xhtml\"" + ">\n<head>\n");
    page.write("<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\"/>\n");
    page.write("<meta http-equiv=\"X-UA-Compatible\" content=\"IE=7\" />\n");
    page.write("<style type=\"text/css\">" + "html, body {height:100%;}</style>");
    page.write("<link rel=\"shortcut icon\" type=\"image/vnd.microsoft.icon\" href=\"" + themeUri + "/favicon.ico\" />");
    page.write("<link rel=\"icon\" type=\"image/vnd.microsoft.icon\" href=\"" + themeUri + "/favicon.ico\" />");
    page.write("<title>" + title + "</title>");
    page.write("\n</head>\n<body scroll=\"auto\" class=\"v-generated-body\">\n");
  }
  String appId=appUrl;
  if ("".equals(appUrl)) {
    appId="ROOT";
  }
  appId=appId.replaceAll("[^a-zA-Z0-9]","");
  int hashCode=appId.hashCode();
  if (hashCode < 0) {
    hashCode=-hashCode;
  }
  appId=appId + "-" + hashCode;
  Application.SystemMessages systemMessages=null;
  try {
    systemMessages=getSystemMessages();
  }
 catch (  SystemMessageException e) {
    throw new ServletException("CommunicationError!",e);
  }
  if (isGecko17(request)) {
    page.write("<iframe tabIndex=\"-1\" id=\"__gwt_historyFrame\" " + "style=\"width:0;height:0;border:0;overflow:" + "hidden\" src=\"javascript:false\"></iframe>\n");
    page.write("<script language='javascript' src='" + widgetsetFilePath + "/"+ WIDGETSET_DIRECTORY_PATH+ widgetset+ "/"+ widgetset+ ".nocache.js?"+ new Date().getTime()+ "'></script>\n");
    page.write("<script type=\"text/javascript\">\n");
    page.write("//<![CDATA[\n");
    page.write("if(!vaadin || !vaadin.vaadinConfigurations) {\n " + "if(!vaadin) { var vaadin = {}} \n" + "vaadin.vaadinConfigurations = {};\n"+ "vaadin.themesLoaded = {}};\n");
    if (!isProductionMode()) {
      page.write("vaadin.debug = true;\n");
    }
    page.write("vaadin.vaadinConfigurations[\"" + appId + "\"] = {");
    page.write("appUri:'" + appUrl + "', ");
    page.write("pathInfo: '" + pathInfo + "', ");
    if (window != application.getMainWindow()) {
      page.write("windowName: '" + window.getName() + "', ");
    }
    page.write("themeUri:");
    page.write(themeBaseUri != null ? "'" + themeBaseUri + "'" : "null");
    page.write(", versionInfo : {vaadinVersion:\"");
    page.write(VERSION);
    page.write("\",applicationVersion:\"");
    page.write(application.getVersion());
    page.write("\"},");
    if (systemMessages != null) {
      String caption=systemMessages.getCommunicationErrorCaption();
      if (caption != null) {
        caption="\"" + caption + "\"";
      }
      String message=systemMessages.getCommunicationErrorMessage();
      if (message != null) {
        message="\"" + message + "\"";
      }
      String url=systemMessages.getCommunicationErrorURL();
      if (url != null) {
        url="\"" + url + "\"";
      }
      page.write("\"comErrMsg\": {" + "\"caption\":" + caption + ","+ "\"message\" : "+ message+ ","+ "\"url\" : "+ url+ "}");
    }
    page.write("};\n//]]>\n</script>\n");
    if (themeName != null) {
      page.write("<script type=\"text/javascript\">\n");
      page.write("//<![CDATA[\n");
      page.write("if(!vaadin.themesLoaded['" + themeName + "']) {\n");
      page.write("var stylesheet = document.createElement('link');\n");
      page.write("stylesheet.setAttribute('rel', 'stylesheet');\n");
      page.write("stylesheet.setAttribute('type', 'text/css');\n");
      page.write("stylesheet.setAttribute('href', '" + themeUri + "/styles.css');\n");
      page.write("document.getElementsByTagName('head')[0].appendChild(stylesheet);\n");
      page.write("vaadin.themesLoaded['" + themeName + "'] = true;\n}\n");
      page.write("//]]>\n</script>\n");
    }
  }
 else {
    page.write("<script type=\"text/javascript\">\n");
    page.write("//<![CDATA[\n");
    page.write("if(!vaadin || !vaadin.vaadinConfigurations) {\n " + "if(!vaadin) { var vaadin = {}} \n" + "vaadin.vaadinConfigurations = {};\n"+ "vaadin.themesLoaded = {};\n");
    if (!isProductionMode()) {
      page.write("vaadin.debug = true;\n");
    }
    page.write("document.write('<iframe tabIndex=\"-1\" id=\"__gwt_historyFrame\" " + "style=\"width:0;height:0;border:0;overflow:" + "hidden\" src=\"javascript:false\"></iframe>');\n");
    page.write("document.write(\"<script language='javascript' src='" + widgetsetFilePath + "/"+ WIDGETSET_DIRECTORY_PATH+ widgetset+ "/"+ widgetset+ ".nocache.js?"+ new Date().getTime()+ "'><\\/script>\");\n}\n");
    page.write("vaadin.vaadinConfigurations[\"" + appId + "\"] = {");
    page.write("appUri:'" + appUrl + "', ");
    page.write("pathInfo: '" + pathInfo + "', ");
    if (window != application.getMainWindow()) {
      page.write("windowName: '" + window.getName() + "', ");
    }
    page.write("themeUri:");
    page.write(themeBaseUri != null ? "'" + themeBaseUri + "'" : "null");
    page.write(", versionInfo : {vaadinVersion:\"");
    page.write(VERSION);
    page.write("\",applicationVersion:\"");
    page.write(application.getVersion());
    page.write("\"},");
    if (systemMessages != null) {
      String caption=systemMessages.getCommunicationErrorCaption();
      if (caption != null) {
        caption="\"" + caption + "\"";
      }
      String message=systemMessages.getCommunicationErrorMessage();
      if (message != null) {
        message="\"" + message + "\"";
      }
      String url=systemMessages.getCommunicationErrorURL();
      if (url != null) {
        url="\"" + url + "\"";
      }
      page.write("\"comErrMsg\": {" + "\"caption\":" + caption + ","+ "\"message\" : "+ message+ ","+ "\"url\" : "+ url+ "}");
    }
    page.write("};\n//]]>\n</script>\n");
    if (themeName != null) {
      page.write("<script type=\"text/javascript\">\n");
      page.write("//<![CDATA[\n");
      page.write("if(!vaadin.themesLoaded['" + themeName + "']) {\n");
      page.write("var stylesheet = document.createElement('link');\n");
      page.write("stylesheet.setAttribute('rel', 'stylesheet');\n");
      page.write("stylesheet.setAttribute('type', 'text/css');\n");
      page.write("stylesheet.setAttribute('href', '" + themeUri + "/styles.css');\n");
      page.write("document.getElementsByTagName('head')[0].appendChild(stylesheet);\n");
      page.write("vaadin.themesLoaded['" + themeName + "'] = true;\n}\n");
      page.write("//]]>\n</script>\n");
    }
  }
  page.write("<script type=\"text/javascript\">\n");
  page.write("//<![CDATA[\n");
  page.write("setTimeout('if (typeof " + widgetset.replace('.','_') + " == \"undefined\") {alert(\"Failed to load the widgetset: "+ widgetsetFilePath+ "/"+ WIDGETSET_DIRECTORY_PATH+ widgetset+ "/"+ widgetset+ ".nocache.js\")};',15000);\n"+ "//]]>\n</script>\n");
  String style=null;
  reqParam=request.getAttribute(REQUEST_APPSTYLE);
  if (reqParam != null) {
    style="style=\"" + reqParam + "\"";
  }
  String appClass="v-app-";
  try {
    appClass+=getApplicationClass().getSimpleName();
  }
 catch (  ClassNotFoundException e) {
    appClass+="unknown";
    e.printStackTrace();
  }
  String themeClass="";
  if (themeName != null) {
    themeClass="v-theme-" + themeName.replaceAll("[^a-zA-Z0-9]","");
  }
 else {
    themeClass="v-theme-" + getDefaultTheme().replaceAll("[^a-zA-Z0-9]","");
  }
  page.write("<div id=\"" + appId + "\" class=\"v-app v-app-loading "+ themeClass+ " "+ appClass+ "\" "+ (style != null ? style : "")+ "></div>\n");
  if (!fragment) {
    page.write("<noscript>" + getNoScriptMessage() + "</noscript>");
    page.write("</body>\n</html>\n");
  }
  page.close();
}
