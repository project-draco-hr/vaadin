{
  boolean repaintAll=(request.getParameter(GET_PARAM_REPAINT_ALL) != null) || request.getSession().isNew();
  OutputStream out=response.getOutputStream();
  PrintWriter outWriter=new PrintWriter(new BufferedWriter(new OutputStreamWriter(out,"UTF-8")));
  outWriter.print(")/*{");
  try {
    DownloadStream download=null;
synchronized (application) {
      Map unhandledParameters=getVariableMap().handleVariables(request,application);
      if (application.isRunning())       download=handleURI(application,request,response);
      if (download == null) {
        Window window=null;
        if (application.isRunning())         window=getApplicationWindow(request,application);
        if (window != null && unhandledParameters != null && !unhandledParameters.isEmpty())         window.handleParameters(unhandledParameters);
        if (!application.isRunning()) {
          endApplication(request,response,application);
          return;
        }
        if (window == null)         return;
        response.setContentType("application/json; charset=UTF-8");
        outWriter.print("\"changes\":[");
        paintTarget=new AjaxJsonPaintTarget(getVariableMap(),this,outWriter);
        Set paintables;
        if (repaintAll) {
          paintables=new LinkedHashSet();
          paintables.add(window);
          locales=null;
          requireLocale(application.getLocale().toString());
          for (Iterator i=window.getApplication().getWindows().iterator(); i.hasNext(); ) {
            Window w=(Window)i.next();
            if (!"native".equals(w.getStyle()) && w != window)             paintables.add(w);
          }
        }
 else         paintables=getDirtyComponents();
        if (paintables != null) {
          List currentPaintables=new ArrayList(paintables);
          Collections.sort(currentPaintables,new Comparator(){
            public int compare(            Object o1,            Object o2){
              if (!(o1 instanceof Window)) {
                return (o2 instanceof Window) ? 1 : 0;
              }
              if (!(o2 instanceof Window)) {
                return -1;
              }
              String n1=((Window)o1).getName();
              String n2=((Window)o2).getName();
              if (o1 instanceof FrameWindow) {
                if (((FrameWindow)o1).getFrameset().getFrame(n2) != null) {
                  return -1;
                }
 else                 if (!(o2 instanceof FrameWindow)) {
                  return -1;
                }
              }
              if (o2 instanceof FrameWindow) {
                if (((FrameWindow)o2).getFrameset().getFrame(n1) != null) {
                  return 1;
                }
 else                 if (!(o1 instanceof FrameWindow)) {
                  return 1;
                }
              }
              return 0;
            }
          }
);
          for (Iterator i=currentPaintables.iterator(); i.hasNext(); ) {
            Paintable p=(Paintable)i.next();
            if (p instanceof Window) {
              Window w=(Window)p;
              if (w.getTerminal() == null)               w.setTerminal(application.getMainWindow().getTerminal());
            }
            paintTarget.startTag("change");
            paintTarget.addAttribute("format","uidl");
            String pid=getPaintableId(p);
            paintTarget.addAttribute("pid",pid);
            ((AjaxPaintTarget)paintTarget).setTrackPaints(true);
            p.paint(paintTarget);
            if (((AjaxPaintTarget)paintTarget).getNumberOfPaints() <= 0) {
              paintTarget.addAttribute("visible",false);
            }
            paintTarget.endTag("change");
            paintablePainted(p);
          }
        }
        ((AjaxPaintTarget)paintTarget).close();
        outWriter.print("]");
        outWriter.print(", \"meta\" : {");
        boolean metaOpen=false;
        if (application.ajaxInit()) {
          outWriter.print("\"appInit\":true");
        }
        Paintable f=(Paintable)application.consumeFocus();
        if (f != null) {
          if (metaOpen)           outWriter.append(",");
          outWriter.write("\"focus\":\"" + getPaintableId(f) + "\"");
        }
        outWriter.print("}, \"resources\" : {");
        String themeName=application.getTheme() != null ? application.getTheme() : ApplicationServlet.DEFAULT_THEME;
        int resourceIndex=0;
        for (Iterator i=((AjaxPaintTarget)paintTarget).getPreCachedResources().iterator(); i.hasNext(); ) {
          String resource=(String)i.next();
          InputStream is=null;
          try {
            is=themeSource.getResource(themeName + "/" + resource);
          }
 catch (          ThemeSource.ThemeException e) {
            Log.info(e.getMessage());
          }
          if (is != null) {
            outWriter.print((resourceIndex++ > 0 ? ", " : "") + "\"" + resource+ "\" : ");
            StringBuffer layout=new StringBuffer();
            try {
              InputStreamReader r=new InputStreamReader(is);
              char[] buffer=new char[20000];
              int charsRead=0;
              while ((charsRead=r.read(buffer)) > 0)               layout.append(buffer,0,charsRead);
              r.close();
            }
 catch (            java.io.IOException e) {
              Log.info("Resource transfer failed:  " + request.getRequestURI() + ". ("+ e.getMessage()+ ")");
            }
            outWriter.print("\"" + AjaxJsonPaintTarget.escapeJSON(layout.toString()) + "\"");
          }
        }
        outWriter.print("}");
        Locale jvmDefault=Locale.getDefault();
        outWriter.print(", \"locales\":[");
        for (; pendingLocalesIndex < locales.size(); pendingLocalesIndex++) {
          Locale l=generateLocale((String)locales.get(pendingLocalesIndex));
          outWriter.print("{\"name\":\"" + l.toString() + "\",");
          DateFormatSymbols dfs=new DateFormatSymbols(l);
          String[] short_months=dfs.getShortMonths();
          String[] months=dfs.getMonths();
          outWriter.print("\"smn\":[\"" + short_months[0] + "\",\""+ short_months[1]+ "\",\""+ short_months[2]+ "\",\""+ short_months[3]+ "\",\""+ short_months[4]+ "\",\""+ short_months[5]+ "\",\""+ short_months[6]+ "\",\""+ short_months[7]+ "\",\""+ short_months[8]+ "\",\""+ short_months[9]+ "\",\""+ short_months[10]+ "\",\""+ short_months[11]+ "\""+ "],");
          outWriter.print("\"mn\":[\"" + months[0] + "\",\""+ months[1]+ "\",\""+ months[2]+ "\",\""+ months[3]+ "\",\""+ months[4]+ "\",\""+ months[5]+ "\",\""+ months[6]+ "\",\""+ months[7]+ "\",\""+ months[8]+ "\",\""+ months[9]+ "\",\""+ months[10]+ "\",\""+ months[11]+ "\""+ "],");
          String[] short_days=dfs.getShortWeekdays();
          String[] days=dfs.getWeekdays();
          outWriter.print("\"sdn\":[\"" + short_days[1] + "\",\""+ short_days[2]+ "\",\""+ short_days[3]+ "\",\""+ short_days[4]+ "\",\""+ short_days[5]+ "\",\""+ short_days[6]+ "\",\""+ short_days[7]+ "\""+ "],");
          outWriter.print("\"dn\":[\"" + days[1] + "\",\""+ days[2]+ "\",\""+ days[3]+ "\",\""+ days[4]+ "\",\""+ days[5]+ "\",\""+ days[6]+ "\",\""+ days[7]+ "\""+ "],");
          Calendar cal=new GregorianCalendar(l);
          outWriter.print("\"fdow\":" + (cal.getFirstDayOfWeek() - 1) + ",");
          Locale.setDefault(l);
          String df=new SimpleDateFormat().toPattern();
          String dateformat=df.substring(0,df.indexOf(" "));
          outWriter.print("\"df\":\"" + dateformat + "\",");
          String timeformat=df.substring(df.indexOf(" ") + 1,df.length());
          boolean twelve_hour_clock=timeformat.contains("a");
          String hour_min_delimiter=timeformat.contains(".") ? "." : ":";
          outWriter.print("\"thc\":" + twelve_hour_clock + ",");
          outWriter.print("\"hmd\":\"" + hour_min_delimiter + "\"");
          if (twelve_hour_clock) {
            String[] ampm=dfs.getAmPmStrings();
            outWriter.print(",\"ampm\":[\"" + ampm[0] + "\",\""+ ampm[1]+ "\"]");
          }
          outWriter.print("}");
          if (pendingLocalesIndex < locales.size() - 1)           outWriter.print(",");
        }
        outWriter.print("]");
        Locale.setDefault(jvmDefault);
        outWriter.flush();
        outWriter.close();
        out.flush();
      }
 else {
        handleDownload(download,request,response);
      }
    }
    out.flush();
    out.close();
  }
 catch (  Throwable e) {
    OutputStreamWriter w=new OutputStreamWriter(out);
    PrintWriter err=new PrintWriter(w);
    err.write("<html><head><title>Application Internal Error</title></head><body>");
    err.write("<h1>" + e.toString() + "</h1><pre>\n");
    e.printStackTrace(new PrintWriter(err));
    err.write("\n</pre></body></html>");
    err.close();
  }
 finally {
  }
}
