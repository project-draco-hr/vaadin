{
  List<Node> sourceChildren=source.childNodes();
  int numDiscarded=0;
  for (  Node sourceChild : sourceChildren) {
    if (sourceChild instanceof Element) {
      Element sourceEl=(Element)sourceChild;
      if (whitelist.isSafeTag(sourceEl.tagName())) {
        ElementMeta meta=createSafeElement(sourceEl);
        Element destChild=meta.el;
        dest.appendChild(destChild);
        numDiscarded+=meta.numAttribsDiscarded;
        numDiscarded+=copySafeNodes(sourceEl,destChild);
      }
 else {
        numDiscarded++;
        numDiscarded+=copySafeNodes(sourceEl,dest);
      }
    }
 else     if (sourceChild instanceof TextNode) {
      TextNode sourceText=(TextNode)sourceChild;
      TextNode destText=new TextNode(sourceText.getWholeText(),sourceChild.baseUri());
      dest.appendChild(destText);
    }
  }
  return numDiscarded;
}
