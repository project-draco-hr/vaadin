{
  Collection<ClientConnector> dirtyVisibleConnectors=ui.getConnectorTracker().getDirtyVisibleConnectors();
  JsonObject sharedStates=Json.createObject();
  for (  ClientConnector connector : dirtyVisibleConnectors) {
    try {
      JsonObject stateJson=connector.encodeState();
      if (stateJson != null && stateJson.keys().length != 0) {
        sharedStates.put(connector.getConnectorId(),stateJson);
      }
    }
 catch (    JsonException e) {
      throw new PaintException("Failed to serialize shared state for connector " + connector.getClass().getName() + " ("+ connector.getConnectorId()+ "): "+ e.getMessage(),e);
    }
  }
  writer.write(JsonUtil.stringify(sharedStates));
}
