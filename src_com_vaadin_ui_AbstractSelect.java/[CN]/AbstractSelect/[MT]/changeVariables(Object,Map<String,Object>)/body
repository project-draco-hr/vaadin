{
  if (isNewItemsAllowed()) {
    final String newitem=(String)variables.get("newitem");
    if (newitem != null && newitem.length() > 0) {
      getNewItemHandler().addNewItem(newitem);
    }
  }
  if (variables.containsKey("selected")) {
    final String[] clientSideSelectedKeys=(String[])variables.get("selected");
    if (isMultiSelect()) {
      final LinkedList<Object> acceptedSelections=new LinkedList<Object>();
      for (int i=0; i < clientSideSelectedKeys.length; i++) {
        final Object id=itemIdMapper.get(clientSideSelectedKeys[i]);
        if (!isNullSelectionAllowed() && (id == null || id == getNullSelectionItemId())) {
          requestRepaint();
        }
 else         if (id != null && containsId(id)) {
          acceptedSelections.add(id);
        }
      }
      if (!isNullSelectionAllowed() && acceptedSelections.size() < 1) {
        requestRepaint();
        return;
      }
      Collection<?> visibleNotSelected=getVisibleItemIds();
      if (visibleNotSelected != null) {
        visibleNotSelected=new HashSet<Object>(visibleNotSelected);
        visibleNotSelected.removeAll(acceptedSelections);
        @SuppressWarnings("unchecked") Set<Object> newsel=(Set<Object>)getValue();
        if (newsel == null) {
          newsel=new LinkedHashSet<Object>();
        }
 else {
          newsel=new LinkedHashSet<Object>(newsel);
        }
        newsel.removeAll(visibleNotSelected);
        newsel.addAll(acceptedSelections);
        setValue(newsel,true);
      }
    }
 else {
      if (!isNullSelectionAllowed() && (clientSideSelectedKeys.length == 0 || clientSideSelectedKeys[0] == null || clientSideSelectedKeys[0] == getNullSelectionItemId())) {
        requestRepaint();
        return;
      }
      if (clientSideSelectedKeys.length == 0) {
        final Object current=getValue();
        final Collection<?> visible=getVisibleItemIds();
        if (visible != null && visible.contains(current)) {
          setValue(null,true);
        }
      }
 else {
        final Object id=itemIdMapper.get(clientSideSelectedKeys[0]);
        if (!isNullSelectionAllowed() && id == null) {
          requestRepaint();
        }
 else         if (id != null && id.equals(getNullSelectionItemId())) {
          setValue(null,true);
        }
 else {
          setValue(id,true);
        }
      }
    }
  }
}
