{
  StringBuilder accum=new StringBuilder(string.length() * 2);
  Map<Character,String> map=escapeMode.getMap();
  for (int pos=0; pos < string.length(); pos++) {
    Character c=string.charAt(pos);
    if (map.containsKey(c)) {
      accum.append('&').append(map.get(c)).append(';');
    }
 else     if (encoder.canEncode(c)) {
      accum.append(c.charValue());
    }
 else {
      accum.append("&#").append((int)c).append(';');
    }
  }
  return accum.toString();
}
