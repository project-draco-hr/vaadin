{
  if (client.updateComponent(this,uidl,true)) {
    return;
  }
  htmlContentAllowed=uidl.hasAttribute(HTML_CONTENT_ALLOWED);
  openRootOnHover=uidl.getBooleanAttribute(OPEN_ROOT_MENU_ON_HOWER);
  enabled=!uidl.getBooleanAttribute("disabled");
  this.client=client;
  uidlId=uidl.getId();
  if (!getItems().isEmpty()) {
    clearItems();
  }
  UIDL options=uidl.getChildUIDL(0);
  if (uidl.hasAttribute("width")) {
    UIDL moreItemUIDL=options.getChildUIDL(0);
    StringBuffer itemHTML=new StringBuffer();
    if (moreItemUIDL.hasAttribute("icon")) {
      itemHTML.append("<img src=\"" + Util.escapeAttribute(client.translateVaadinUri(moreItemUIDL.getStringAttribute("icon"))) + "\" class=\""+ Icon.CLASSNAME+ "\" alt=\"\" />");
    }
    String moreItemText=moreItemUIDL.getStringAttribute("text");
    if ("".equals(moreItemText)) {
      moreItemText="&#x25BA;";
    }
    itemHTML.append(moreItemText);
    moreItem=GWT.create(CustomMenuItem.class);
    moreItem.setHTML(itemHTML.toString());
    moreItem.setCommand(emptyCommand);
    collapsedRootItems=new VMenuBar(true,(VMenuBar)client.getPaintable(uidlId));
    moreItem.setSubMenu(collapsedRootItems);
    moreItem.addStyleName(CLASSNAME + "-more-menuitem");
  }
  UIDL uidlItems=uidl.getChildUIDL(1);
  Iterator<Object> itr=uidlItems.getChildIterator();
  Stack<Iterator<Object>> iteratorStack=new Stack<Iterator<Object>>();
  Stack<VMenuBar> menuStack=new Stack<VMenuBar>();
  VMenuBar currentMenu=this;
  while (itr.hasNext()) {
    UIDL item=(UIDL)itr.next();
    CustomMenuItem currentItem=null;
    final int itemId=item.getIntAttribute("id");
    boolean itemHasCommand=item.hasAttribute("command");
    boolean itemIsCheckable=item.hasAttribute(ATTRIBUTE_CHECKED);
    String itemHTML=buildItemHTML(item);
    Command cmd=null;
    if (!item.hasAttribute("separator")) {
      if (itemHasCommand || itemIsCheckable) {
        cmd=new Command(){
          public void execute(){
            hostReference.onMenuClick(itemId);
          }
        }
;
      }
    }
    currentItem=currentMenu.addItem(itemHTML.toString(),cmd);
    currentItem.updateFromUIDL(item,client);
    if (item.getChildCount() > 0) {
      menuStack.push(currentMenu);
      iteratorStack.push(itr);
      itr=item.getChildIterator();
      currentMenu=new VMenuBar(true,currentMenu);
      if (uidl.hasAttribute("style")) {
        for (        String style : uidl.getStringAttribute("style").split(" ")) {
          currentMenu.addStyleDependentName(style);
        }
      }
      currentItem.setSubMenu(currentMenu);
    }
    while (!itr.hasNext() && !iteratorStack.empty()) {
      boolean hasCheckableItem=false;
      for (      CustomMenuItem menuItem : currentMenu.getItems()) {
        hasCheckableItem=hasCheckableItem || menuItem.isCheckable();
      }
      if (hasCheckableItem) {
        currentMenu.addStyleDependentName("check-column");
      }
 else {
        currentMenu.removeStyleDependentName("check-column");
      }
      itr=iteratorStack.pop();
      currentMenu=menuStack.pop();
    }
  }
  iLayout(false);
}
