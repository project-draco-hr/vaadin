{
  Window window=null;
  String windowClientRequestedName=request.getParameter("windowName");
  if (assumedWindow != null && application.getWindows().contains(assumedWindow)) {
    windowClientRequestedName=assumedWindow.getName();
  }
  if (windowClientRequestedName != null) {
    window=application.getWindow(windowClientRequestedName);
    if (window != null) {
      return window;
    }
  }
  if (window == null && !request.isRunningInPortlet()) {
    String path=callback.getRequestPathInfo(request);
    boolean pathMayContainWindowName=path != null && path.length() > 0 && !path.equals("/");
    if (pathMayContainWindowName) {
      boolean uidlRequest=path.startsWith("/UIDL");
      if (!uidlRequest) {
        String windowUrlName=null;
        if (path.charAt(0) == '/') {
          path=path.substring(1);
        }
        final int index=path.indexOf('/');
        if (index < 0) {
          windowUrlName=path;
          path="";
        }
 else {
          windowUrlName=path.substring(0,index);
          path=path.substring(index + 1);
        }
        window=application.getWindow(windowUrlName);
      }
    }
  }
  if (window == null) {
    window=application.getMainWindow();
    if (window == null) {
      return null;
    }
  }
  if (currentlyOpenWindowsInClient.containsKey(window.getName())) {
    String newWindowName=window.getName();
synchronized (AbstractCommunicationManager.class) {
      while (currentlyOpenWindowsInClient.containsKey(newWindowName)) {
        newWindowName=window.getName() + "_" + nextUnusedWindowSuffix++;
      }
    }
    window=application.getWindow(newWindowName);
    if (window == null) {
      window=application.getMainWindow();
    }
  }
  return window;
}
