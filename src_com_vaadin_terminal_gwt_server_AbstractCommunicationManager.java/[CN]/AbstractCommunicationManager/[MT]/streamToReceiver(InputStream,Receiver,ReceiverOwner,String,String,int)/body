{
  if (receiver == null) {
    throw new IllegalStateException("Receiver for the post not found");
  }
  ReceivingController controller=source.getReceivingController(receiver);
  final Application application=getApplication();
  OutputStream out=null;
  try {
    boolean listenProgress;
synchronized (application) {
      ReceivingStartedEvent startedEvent=new ReceivingStartedEventImpl(receiver,filename,type,contentLength);
      controller.uploadStarted(startedEvent);
      out=receiver.receiveUpload(filename,type);
      listenProgress=controller.listenProgress();
    }
    if (out == null) {
      throw new NoOutputStreamException();
    }
    if (null == in) {
      throw new NoInputStreamException();
    }
    final byte buffer[]=new byte[MAX_UPLOAD_BUFFER_SIZE];
    int bytesReadToBuffer=0;
    int totalBytes=0;
    ReceivingProgressedEventImpl progressEvent=new ReceivingProgressedEventImpl(receiver,filename,type,contentLength);
    while ((bytesReadToBuffer=in.read(buffer)) > 0) {
      out.write(buffer,0,bytesReadToBuffer);
      totalBytes+=bytesReadToBuffer;
      if (listenProgress) {
synchronized (application) {
          progressEvent.setBytesReceived(totalBytes);
          controller.onProgress(progressEvent);
        }
      }
      if (controller.isInterrupted()) {
        throw new UploadInterruptedException();
      }
    }
    out.close();
    ReceivingEndedEvent event=new ReceivingEndedEventImpl(receiver,filename,type,totalBytes);
synchronized (application) {
      controller.uploadFinished(event);
    }
  }
 catch (  UploadInterruptedException e) {
    try {
      out.close();
    }
 catch (    IOException e1) {
    }
    ReceivingFailedEvent event=new ReceivingFailedEventImpl(receiver,filename,type,contentLength,e);
synchronized (application) {
      controller.uploadFailed(event);
    }
  }
catch (  final Exception e) {
synchronized (application) {
      ReceivingFailedEvent event=new ReceivingFailedEventImpl(receiver,filename,type,contentLength,e);
synchronized (application) {
        controller.uploadFailed(event);
      }
      throw new UploadException(e);
    }
  }
}
