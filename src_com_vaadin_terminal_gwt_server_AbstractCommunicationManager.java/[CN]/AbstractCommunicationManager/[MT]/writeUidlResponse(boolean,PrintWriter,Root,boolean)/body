{
  ArrayList<Paintable> paintables=null;
  if (repaintAll) {
    paintables=new ArrayList<Paintable>();
    paintables.add(root);
    locales=null;
    requireLocale(application.getLocale().toString());
  }
 else {
    for (Iterator<Paintable> it=paintableIdMap.keySet().iterator(); it.hasNext(); ) {
      Component p=(Component)it.next();
      if (p.getApplication() == null) {
        unregisterPaintable(p);
        String pid=paintableIdMap.get(p);
        if (idPaintableMap.get(pid) == p) {
          idPaintableMap.remove(pid);
        }
        it.remove();
        dirtyPaintables.remove(p);
      }
    }
    paintables=getDirtyVisibleComponents(root);
  }
  outWriter.print("\"changes\":[");
  List<InvalidLayout> invalidComponentRelativeSizes=null;
  JsonPaintTarget paintTarget=new JsonPaintTarget(this,outWriter,!repaintAll);
  OpenWindowCache windowCache=currentlyOpenWindowsInClient.get(Integer.valueOf(root.getRootId()));
  if (windowCache == null) {
    windowCache=new OpenWindowCache();
    currentlyOpenWindowsInClient.put(Integer.valueOf(root.getRootId()),windowCache);
  }
  LinkedList<Paintable> stateQueue=new LinkedList<Paintable>();
  LinkedList<Paintable> rpcPendingQueue=new LinkedList<Paintable>();
  LinkedList<Paintable> hierarchyPendingQueue=new LinkedList<Paintable>();
  LinkedList<Paintable> connectorTypeQueue=new LinkedList<Paintable>();
  if (paintables != null) {
    paintQueue.clear();
    paintQueue.addAll(paintables);
    while (!paintQueue.isEmpty()) {
      final Paintable p=paintQueue.removeFirst();
      stateQueue.push(p);
      connectorTypeQueue.push(p);
      hierarchyPendingQueue.push(p);
      rpcPendingQueue.push(p);
      if (paintTarget.needsToBePainted(p)) {
        paintTarget.startTag("change");
        final String pid=getPaintableId(p);
        paintTarget.addAttribute("pid",pid);
        p.paint(paintTarget);
        paintTarget.endTag("change");
      }
      paintablePainted(p);
      if (analyzeLayouts) {
        Root w=(Root)p;
        invalidComponentRelativeSizes=ComponentSizeValidator.validateComponentRelativeSizes(w.getContent(),null,null);
      }
    }
  }
  paintTarget.close();
  outWriter.print("], ");
  if (!stateQueue.isEmpty()) {
    JSONObject sharedStates=new JSONObject();
    while (!stateQueue.isEmpty()) {
      final Paintable p=stateQueue.pop();
      String paintableId=getPaintableId(p);
      SharedState state=p.getState();
      if (null != state) {
        try {
          JSONArray stateJsonArray=JsonCodec.encode(state,this);
          sharedStates.put(paintableId,stateJsonArray);
        }
 catch (        JSONException e) {
          throw new PaintException("Failed to serialize shared state for paintable " + paintableId + ": "+ e.getMessage());
        }
      }
    }
    outWriter.print("\"state\":");
    outWriter.append(sharedStates.toString());
    outWriter.print(", ");
  }
  if (!connectorTypeQueue.isEmpty()) {
    JSONObject connectorTypes=new JSONObject();
    while (!connectorTypeQueue.isEmpty()) {
      final Paintable p=connectorTypeQueue.pop();
      String paintableId=getPaintableId(p);
      String connectorType=paintTarget.getTag(p);
      try {
        connectorTypes.put(paintableId,connectorType);
      }
 catch (      JSONException e) {
        throw new PaintException("Failed to send connector type for paintable " + paintableId + ": "+ e.getMessage());
      }
    }
    outWriter.print("\"types\":");
    outWriter.append(connectorTypes.toString());
    outWriter.print(", ");
  }
  if (!hierarchyPendingQueue.isEmpty()) {
    outWriter.print("\"hierarchy\":");
    JSONObject hierarchyInfo=new JSONObject();
    for (    Paintable p : hierarchyPendingQueue) {
      if (p instanceof HasComponents) {
        HasComponents parent=(HasComponents)p;
        String parentConnectorId=paintableIdMap.get(parent);
        JSONArray children=new JSONArray();
        for (        Component child : getChildComponents(parent)) {
          if (isVisible(child)) {
            String childConnectorId=getPaintableId(child);
            children.put(childConnectorId);
          }
        }
        try {
          hierarchyInfo.put(parentConnectorId,children);
        }
 catch (        JSONException e) {
          throw new PaintException("Failed to send hierarchy information about " + parentConnectorId + " to the client: "+ e.getMessage());
        }
      }
    }
    outWriter.append(hierarchyInfo.toString());
    outWriter.print(", ");
  }
  if (!rpcPendingQueue.isEmpty()) {
    List<ClientMethodInvocation> pendingInvocations=collectPendingRpcCalls(rpcPendingQueue);
    JSONArray rpcCalls=new JSONArray();
    for (    ClientMethodInvocation invocation : pendingInvocations) {
      try {
        JSONArray invocationJson=new JSONArray();
        invocationJson.put(getPaintableId(invocation.getPaintable()));
        invocationJson.put(invocation.getInterfaceName());
        invocationJson.put(invocation.getMethodName());
        JSONArray paramJson=new JSONArray();
        for (int i=0; i < invocation.getParameters().length; ++i) {
          paramJson.put(JsonCodec.encode(invocation.getParameters()[i],this));
        }
        invocationJson.put(paramJson);
        rpcCalls.put(invocationJson);
      }
 catch (      JSONException e) {
        throw new PaintException("Failed to serialize RPC method call parameters for paintable " + getPaintableId(invocation.getPaintable()) + " method "+ invocation.getInterfaceName()+ "."+ invocation.getMethodName()+ ": "+ e.getMessage());
      }
    }
    if (rpcCalls.length() > 0) {
      outWriter.print("\"rpc\" : ");
      outWriter.append(rpcCalls.toString());
      outWriter.print(", ");
    }
  }
  outWriter.print("\"meta\" : {");
  boolean metaOpen=false;
  if (repaintAll) {
    metaOpen=true;
    outWriter.write("\"repaintAll\":true");
    if (analyzeLayouts) {
      outWriter.write(", \"invalidLayouts\":");
      outWriter.write("[");
      if (invalidComponentRelativeSizes != null) {
        boolean first=true;
        for (        InvalidLayout invalidLayout : invalidComponentRelativeSizes) {
          if (!first) {
            outWriter.write(",");
          }
 else {
            first=false;
          }
          invalidLayout.reportErrors(outWriter,this,System.err);
        }
      }
      outWriter.write("]");
    }
    if (highLightedPaintable != null) {
      outWriter.write(", \"hl\":\"");
      outWriter.write(paintableIdMap.get(highLightedPaintable));
      outWriter.write("\"");
      highLightedPaintable=null;
    }
  }
  SystemMessages ci=null;
  try {
    Method m=application.getClass().getMethod("getSystemMessages",(Class[])null);
    ci=(Application.SystemMessages)m.invoke(null,(Object[])null);
  }
 catch (  NoSuchMethodException e) {
    logger.log(Level.WARNING,"getSystemMessages() failed - continuing",e);
  }
catch (  IllegalArgumentException e) {
    logger.log(Level.WARNING,"getSystemMessages() failed - continuing",e);
  }
catch (  IllegalAccessException e) {
    logger.log(Level.WARNING,"getSystemMessages() failed - continuing",e);
  }
catch (  InvocationTargetException e) {
    logger.log(Level.WARNING,"getSystemMessages() failed - continuing",e);
  }
  if (ci != null && ci.getSessionExpiredMessage() == null && ci.getSessionExpiredCaption() == null && ci.isSessionExpiredNotificationEnabled()) {
    int newTimeoutInterval=getTimeoutInterval();
    if (repaintAll || (timeoutInterval != newTimeoutInterval)) {
      String escapedURL=ci.getSessionExpiredURL() == null ? "" : ci.getSessionExpiredURL().replace("/","\\/");
      if (metaOpen) {
        outWriter.write(",");
      }
      outWriter.write("\"timedRedirect\":{\"interval\":" + (newTimeoutInterval + 15) + ",\"url\":\""+ escapedURL+ "\"}");
      metaOpen=true;
    }
    timeoutInterval=newTimeoutInterval;
  }
  outWriter.print("}, \"resources\" : {");
  int resourceIndex=0;
  for (final Iterator<Object> i=paintTarget.getUsedResources().iterator(); i.hasNext(); ) {
    final String resource=(String)i.next();
    InputStream is=null;
    try {
      is=getThemeResourceAsStream(root,getTheme(root),resource);
    }
 catch (    final Exception e) {
      logger.log(Level.FINER,"Failed to get theme resource stream.",e);
    }
    if (is != null) {
      outWriter.print((resourceIndex++ > 0 ? ", " : "") + "\"" + resource+ "\" : ");
      final StringBuffer layout=new StringBuffer();
      try {
        final InputStreamReader r=new InputStreamReader(is,"UTF-8");
        final char[] buffer=new char[20000];
        int charsRead=0;
        while ((charsRead=r.read(buffer)) > 0) {
          layout.append(buffer,0,charsRead);
        }
        r.close();
      }
 catch (      final java.io.IOException e) {
        logger.log(Level.INFO,"Resource transfer failed",e);
      }
      outWriter.print("\"" + JsonPaintTarget.escapeJSON(layout.toString()) + "\"");
    }
 else {
      logger.severe("CustomLayout not found: " + resource);
    }
  }
  outWriter.print("}");
  Collection<Class<? extends Paintable>> usedPaintableTypes=paintTarget.getUsedPaintableTypes();
  boolean typeMappingsOpen=false;
  for (  Class<? extends Paintable> class1 : usedPaintableTypes) {
    if (windowCache.cache(class1)) {
      if (!typeMappingsOpen) {
        typeMappingsOpen=true;
        outWriter.print(", \"typeMappings\" : { ");
      }
 else {
        outWriter.print(" , ");
      }
      String canonicalName=class1.getCanonicalName();
      outWriter.print("\"");
      outWriter.print(canonicalName);
      outWriter.print("\" : ");
      outWriter.print(getTagForType(class1));
    }
  }
  if (typeMappingsOpen) {
    outWriter.print(" }");
  }
  printLocaleDeclarations(outWriter);
  if (dragAndDropService != null) {
    dragAndDropService.printJSONResponse(outWriter);
  }
}
