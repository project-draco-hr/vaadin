{
  boolean sendUIDL=Root.getCurrentRoot() == null;
  CombinedRequest combinedRequest=application.getCombinedRequest(request);
  try {
    Root root=application.getRootForRequest(combinedRequest);
    AjaxPageHandler ajaxPageHandler=getAjaxPageHandler();
    AjaxPageContext context=ajaxPageHandler.createContext(combinedRequest,response,application,root.getRootId());
    String widgetset=context.getWidgetsetName();
    String theme=context.getThemeName();
    String themeUri=ajaxPageHandler.getThemeUri(context,theme);
    JSONObject params=new JSONObject();
    params.put("widgetset",widgetset);
    params.put("themeUri",themeUri);
    params.put(ApplicationConnection.ROOT_ID_PARAMETER,root.getRootId());
    if (sendUIDL) {
      this.makeAllPaintablesDirty(root);
      StringWriter sWriter=new StringWriter();
      PrintWriter pWriter=new PrintWriter(sWriter);
      pWriter.print("{");
      if (isXSRFEnabled(application)) {
        pWriter.print(getSecurityKeyUIDL(combinedRequest));
      }
      writeUidlResponce(null,true,pWriter,root,false);
      pWriter.print("}");
      params.put("uidl",sWriter.toString());
    }
    response.getWriter().write(params.toString());
  }
 catch (  RootRequiresMoreInformation e) {
    throw new RuntimeException(e);
  }
catch (  JSONException e) {
    e.printStackTrace();
  }
}
