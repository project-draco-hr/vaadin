{
  if (repaintAll) {
    makeAllPaintablesDirty(window);
  }
  if (!application.isRunning()) {
    endApplication(request,response,application);
    return;
  }
  response.setContentType("application/json; charset=UTF-8");
  openJsonMessage(outWriter);
  Object writeSecurityTokenFlag=request.getAttribute(WRITE_SECURITY_TOKEN_FLAG);
  if (writeSecurityTokenFlag != null) {
    String seckey=(String)request.getSession().getAttribute(ApplicationConnection.UIDL_SECURITY_TOKEN_ID);
    if (seckey == null) {
      seckey=UUID.randomUUID().toString();
      request.getSession().setAttribute(ApplicationConnection.UIDL_SECURITY_TOKEN_ID,seckey);
    }
    outWriter.print("\"" + ApplicationConnection.UIDL_SECURITY_TOKEN_ID + "\":\"");
    outWriter.print(seckey);
    outWriter.print("\",");
  }
  if (window.getName().equals(closingWindowName)) {
    outWriter.print("\"changes\":[]");
  }
 else {
    Window newWindow=doGetApplicationWindow(request,callback,application,window);
    if (newWindow != window) {
      window=newWindow;
      repaintAll=true;
    }
    writeUidlResponce(callback,repaintAll,outWriter,window,analyzeLayouts);
  }
  closeJsonMessage(outWriter);
  outWriter.close();
}
