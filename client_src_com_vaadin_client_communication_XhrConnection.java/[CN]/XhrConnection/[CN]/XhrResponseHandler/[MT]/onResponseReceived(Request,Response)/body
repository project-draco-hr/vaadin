{
  int statusCode=response.getStatusCode();
  if (statusCode != 200) {
    CommunicationProblemEvent problemEvent=new CommunicationProblemEvent(request,payload,response);
    getCommunicationProblemHandler().xhrInvalidStatusCode(problemEvent);
    return;
  }
  getLogger().info("Server visit took " + String.valueOf((new Date()).getTime() - requestStartTime.getTime()) + "ms");
  String contentType=response.getHeader("Content-Type");
  if (contentType == null || !contentType.startsWith("application/json")) {
    getCommunicationProblemHandler().xhrInvalidContent(new CommunicationProblemEvent(request,payload,response));
    return;
  }
  String responseText=response.getText();
  final String jsonText=ServerCommunicationHandler.stripJSONWrapping(responseText);
  if (jsonText == null) {
    getCommunicationProblemHandler().xhrInvalidContent(new CommunicationProblemEvent(request,payload,response));
    return;
  }
  getCommunicationProblemHandler().xhrOk();
  getLogger().info("Received xhr message: " + jsonText);
  getServerMessageHandler().handleMessage(jsonText);
}
