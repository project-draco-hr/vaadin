{
  if (getTabIndex() > 0) {
    target.addAttribute("tabindex",getTabIndex());
  }
  final Object[] colids=getVisibleColumns();
  final int cols=colids.length;
  final int first=getCurrentPageFirstItemIndex();
  int total=size();
  final int pagelen=getPageLength();
  final int colHeadMode=getColumnHeaderMode();
  final boolean colheads=colHeadMode != COLUMN_HEADER_MODE_HIDDEN;
  final boolean rowheads=getRowHeaderMode() != ROW_HEADER_MODE_HIDDEN;
  final Object[][] cells=getVisibleCells();
  final boolean iseditable=isEditable();
  int rows;
  if (reqRowsToPaint >= 0) {
    rows=reqRowsToPaint;
  }
 else {
    rows=cells[0].length;
  }
  if (!isNullSelectionAllowed() && getNullSelectionItemId() != null && containsId(getNullSelectionItemId())) {
    total--;
    rows--;
  }
  LinkedList selectedKeys=new LinkedList();
  if (isMultiSelect()) {
    HashSet sel=new HashSet((Set)getValue());
    Collection vids=getVisibleItemIds();
    for (Iterator it=vids.iterator(); it.hasNext(); ) {
      Object id=it.next();
      if (sel.contains(id)) {
        selectedKeys.add(itemIdMapper.key(id));
      }
    }
  }
 else {
    Object value=getValue();
    if (value == null) {
      value=getNullSelectionItemId();
    }
    if (value != null) {
      selectedKeys.add(itemIdMapper.key(value));
    }
  }
  if (isSelectable()) {
    target.addAttribute("selectmode",(isMultiSelect() ? "multi" : "single"));
  }
 else {
    target.addAttribute("selectmode","none");
  }
  if (clickListenerCount > 0) {
    target.addAttribute("listenClicks",true);
  }
  target.addAttribute("cols",cols);
  target.addAttribute("rows",rows);
  target.addAttribute("firstrow",(reqFirstRowToPaint >= 0 ? reqFirstRowToPaint : firstToBeRenderedInClient));
  target.addAttribute("totalrows",total);
  if (pagelen != 0) {
    target.addAttribute("pagelength",pagelen);
  }
  if (colheads) {
    target.addAttribute("colheaders",true);
  }
  if (rowheads) {
    target.addAttribute("rowheaders",true);
  }
  final Collection sortables=getSortableContainerPropertyIds();
  final ArrayList visibleColOrder=new ArrayList();
  for (final Iterator it=visibleColumns.iterator(); it.hasNext(); ) {
    final Object columnId=it.next();
    if (!isColumnCollapsed(columnId)) {
      visibleColOrder.add(columnIdMap.key(columnId));
    }
  }
  target.addAttribute("vcolorder",visibleColOrder.toArray());
  final Set actionSet=new LinkedHashSet();
  final boolean selectable=isSelectable();
  final boolean[] iscomponent=new boolean[visibleColumns.size()];
  int iscomponentIndex=0;
  for (final Iterator it=visibleColumns.iterator(); it.hasNext() && iscomponentIndex < iscomponent.length; ) {
    final Object columnId=it.next();
    if (columnGenerators.containsKey(columnId)) {
      iscomponent[iscomponentIndex++]=true;
    }
 else {
      final Class colType=getType(columnId);
      iscomponent[iscomponentIndex++]=colType != null && Component.class.isAssignableFrom(colType);
    }
  }
  target.startTag("rows");
  int start=0;
  if (reqFirstRowToPaint != -1 && firstToBeRenderedInClient != -1) {
    start=reqFirstRowToPaint - firstToBeRenderedInClient;
  }
  int end=cells[0].length;
  if (reqRowsToPaint != -1) {
    end=start + reqRowsToPaint;
  }
  if (lastToBeRenderedInClient != -1 && lastToBeRenderedInClient < end) {
    end=lastToBeRenderedInClient + 1;
  }
  if (start > cells[CELL_ITEMID].length || start < 0) {
    start=0;
  }
  for (int i=start; i < end; i++) {
    final Object itemId=cells[CELL_ITEMID][i];
    if (!isNullSelectionAllowed() && getNullSelectionItemId() != null && itemId == getNullSelectionItemId()) {
      continue;
    }
    target.startTag("tr");
    if (rowheads) {
      if (cells[CELL_ICON][i] != null) {
        target.addAttribute("icon",(Resource)cells[CELL_ICON][i]);
      }
      if (cells[CELL_HEADER][i] != null) {
        target.addAttribute("caption",(String)cells[CELL_HEADER][i]);
      }
    }
    target.addAttribute("key",Integer.parseInt(cells[CELL_KEY][i].toString()));
    if (actionHandlers != null || isSelectable()) {
      if (isSelected(itemId)) {
        target.addAttribute("selected",true);
      }
    }
    if (actionHandlers != null) {
      final ArrayList keys=new ArrayList();
      for (final Iterator ahi=actionHandlers.iterator(); ahi.hasNext(); ) {
        final Action[] aa=((Action.Handler)ahi.next()).getActions(itemId,this);
        if (aa != null) {
          for (int ai=0; ai < aa.length; ai++) {
            final String key=actionMapper.key(aa[ai]);
            actionSet.add(aa[ai]);
            keys.add(key);
          }
        }
      }
      target.addAttribute("al",keys.toArray());
    }
    if (cellStyleGenerator != null) {
      String rowStyle=cellStyleGenerator.getStyle(itemId,null);
      if (rowStyle != null && !rowStyle.equals("")) {
        target.addAttribute("rowstyle",rowStyle);
      }
    }
    int currentColumn=0;
    for (final Iterator it=visibleColumns.iterator(); it.hasNext(); currentColumn++) {
      final Object columnId=it.next();
      if (columnId == null || isColumnCollapsed(columnId)) {
        continue;
      }
      if (cellStyleGenerator != null) {
        String cellStyle=cellStyleGenerator.getStyle(itemId,columnId);
        if (cellStyle != null && !cellStyle.equals("")) {
          target.addAttribute("style-" + currentColumn,cellStyle);
        }
      }
      if ((iscomponent[currentColumn] || iseditable) && Component.class.isInstance(cells[CELL_FIRSTCOL + currentColumn][i])) {
        final Component c=(Component)cells[CELL_FIRSTCOL + currentColumn][i];
        if (c == null) {
          target.addText("");
        }
 else {
          c.requestRepaint();
          c.paint(target);
        }
      }
 else {
        target.addText((String)cells[CELL_FIRSTCOL + currentColumn][i]);
      }
    }
    target.endTag("tr");
  }
  target.endTag("rows");
  if (selectable && selectedKeys.size() > 0) {
    target.addVariable(this,"selected",(String[])selectedKeys.toArray(new String[selectedKeys.size()]));
  }
  if (first != 0 || getPageLength() > 0) {
    target.addVariable(this,"firstvisible",first);
  }
  if (getContainerDataSource() instanceof Container.Sortable) {
    target.addVariable(this,"sortcolumn",columnIdMap.key(sortContainerPropertyId));
    target.addVariable(this,"sortascending",sortAscending);
  }
  reqFirstRowToPaint=-1;
  reqRowsToPaint=-1;
  containerChangeToBeRendered=false;
  target.addVariable(this,"reqrows",reqRowsToPaint);
  target.addVariable(this,"reqfirstrow",reqFirstRowToPaint);
  if (!actionSet.isEmpty()) {
    target.addVariable(this,"action","");
    target.startTag("actions");
    for (final Iterator it=actionSet.iterator(); it.hasNext(); ) {
      final Action a=(Action)it.next();
      target.startTag("action");
      if (a.getCaption() != null) {
        target.addAttribute("caption",a.getCaption());
      }
      if (a.getIcon() != null) {
        target.addAttribute("icon",a.getIcon());
      }
      target.addAttribute("key",actionMapper.key(a));
      target.endTag("action");
    }
    target.endTag("actions");
  }
  if (columnReorderingAllowed) {
    final String[] colorder=new String[visibleColumns.size()];
    int i=0;
    for (final Iterator it=visibleColumns.iterator(); it.hasNext() && i < colorder.length; ) {
      colorder[i++]=columnIdMap.key(it.next());
    }
    target.addVariable(this,"columnorder",colorder);
  }
  if (columnCollapsingAllowed) {
    final HashSet ccs=new HashSet();
    for (final Iterator i=visibleColumns.iterator(); i.hasNext(); ) {
      final Object o=i.next();
      if (isColumnCollapsed(o)) {
        ccs.add(o);
      }
    }
    final String[] collapsedkeys=new String[ccs.size()];
    int nextColumn=0;
    for (final Iterator it=visibleColumns.iterator(); it.hasNext() && nextColumn < collapsedkeys.length; ) {
      final Object columnId=it.next();
      if (isColumnCollapsed(columnId)) {
        collapsedkeys[nextColumn++]=columnIdMap.key(columnId);
      }
    }
    target.addVariable(this,"collapsedcolumns",collapsedkeys);
  }
  target.startTag("visiblecolumns");
  int i=0;
  for (final Iterator it=visibleColumns.iterator(); it.hasNext(); i++) {
    final Object columnId=it.next();
    if (columnId != null) {
      target.startTag("column");
      target.addAttribute("cid",columnIdMap.key(columnId));
      final String head=getColumnHeader(columnId);
      target.addAttribute("caption",(head != null ? head : ""));
      if (isColumnCollapsed(columnId)) {
        target.addAttribute("collapsed",true);
      }
      if (colheads) {
        if (getColumnIcon(columnId) != null) {
          target.addAttribute("icon",getColumnIcon(columnId));
        }
        if (sortables.contains(columnId)) {
          target.addAttribute("sortable",true);
        }
      }
      if (!ALIGN_LEFT.equals(getColumnAlignment(columnId))) {
        target.addAttribute("align",getColumnAlignment(columnId));
      }
      if (getColumnWidth(columnId) > -1) {
        target.addAttribute("width",String.valueOf(getColumnWidth(columnId)));
      }
      target.endTag("column");
    }
  }
  target.endTag("visiblecolumns");
}
