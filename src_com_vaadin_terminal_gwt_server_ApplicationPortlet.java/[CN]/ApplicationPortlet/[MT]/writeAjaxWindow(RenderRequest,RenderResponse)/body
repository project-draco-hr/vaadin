{
  response.setContentType("text/html");
  if (app != null) {
    PortletSession sess=request.getPortletSession();
    PortletApplicationContext ctx=PortletApplicationContext.getApplicationContext(sess);
    PortletRequestDispatcher dispatcher=sess.getPortletContext().getRequestDispatcher("/" + app);
    try {
      request.setAttribute(ApplicationServlet.REQUEST_FRAGMENT,"true");
      if (widgetset != null) {
        request.setAttribute(ApplicationServlet.REQUEST_WIDGETSET,widgetset);
      }
      if (style != null) {
        request.setAttribute(ApplicationServlet.REQUEST_APPSTYLE,style);
      }
      dispatcher.include(request,response);
      boolean isLifeRay=request.getPortalContext().getPortalInfo().toLowerCase().contains("liferay");
      if (isLifeRay) {
        OutputStream out=response.getPortletOutputStream();
        byte[] lifeRaySessionHearbeatHack=("<script type=\"text/javascript\">" + "if(!vaadin.postRequestHooks) {vaadin.postRequestHooks = {};}" + "vaadin.postRequestHooks.liferaySessionHeartBeat = function()"+ "{Liferay.Session.setCookie();};</script>").getBytes();
        out.write(lifeRaySessionHearbeatHack);
      }
    }
 catch (    PortletException e) {
      PrintWriter out=response.getWriter();
      out.print("<h1>Servlet include failed!</h1>");
      out.print("<div>" + e + "</div>");
      ctx.setPortletApplication(this,null);
      return;
    }
    Application app=(Application)request.getAttribute(Application.class.getName());
    ctx.setPortletApplication(this,app);
    ctx.firePortletRenderRequest(this,request,response);
  }
}
