{
  response.setContentType("text/html");
  if (app != null) {
    PortletSession sess=request.getPortletSession();
    PortletApplicationContext ctx=PortletApplicationContext.getApplicationContext(sess);
    PortletRequestDispatcher dispatcher=sess.getPortletContext().getRequestDispatcher("/" + app);
    try {
      PortalContext portalCtx=request.getPortalContext();
      boolean isLifeRay=portalCtx.getPortalInfo().toLowerCase().contains("liferay");
      request.setAttribute(ApplicationServlet.REQUEST_FRAGMENT,"true");
      String portalTheme=getPortalProperty(PORTAL_PARAMETER_VAADIN_THEME,portalCtx);
      String portalWidgetset=getPortalProperty(PORTAL_PARAMETER_VAADIN_WIDGETSET,portalCtx);
      String portalResourcePath=getPortalProperty(PORTAL_PARAMETER_VAADIN_RESOURCE_PATH,portalCtx);
      if (isLifeRay && portalResourcePath == null) {
        portalResourcePath="/html";
      }
      if (portalWidgetset != null) {
        if (portalResourcePath != null) {
          request.setAttribute(ApplicationServlet.REQUEST_VAADIN_WIDGETSET_PATH,portalResourcePath);
        }
        request.setAttribute(ApplicationServlet.REQUEST_WIDGETSET,portalWidgetset);
      }
 else       if (portletWidgetset != null) {
        request.setAttribute(ApplicationServlet.REQUEST_WIDGETSET,portletWidgetset);
      }
      if (style != null) {
        request.setAttribute(ApplicationServlet.REQUEST_APPSTYLE,style);
      }
      String themeUri=null;
      if (portalTheme != null) {
        themeUri=portalResourcePath + "/" + AbstractApplicationServlet.THEME_DIRECTORY_PATH+ portalTheme;
        request.setAttribute(ApplicationServlet.REQUEST_DEFAULT_THEME_URI,portalTheme);
      }
      if (portalTheme != null) {
        OutputStream out=response.getPortletOutputStream();
        String loadDefaultTheme=("<script type=\"text/javascript\">\n" + "if(!vaadin) { var vaadin = {} } \n" + "if(!vaadin.themesLoaded) { vaadin.themesLoaded = {} } \n"+ "if(!vaadin.themesLoaded['" + portalTheme + "']) {\n"+ "var stylesheet = document.createElement('link');\n"+ "stylesheet.setAttribute('rel', 'stylesheet');\n"+ "stylesheet.setAttribute('type', 'text/css');\n"+ "stylesheet.setAttribute('href', '"+ themeUri+ "/styles.css');\n"+ "document.getElementsByTagName('head')[0].appendChild(stylesheet);\n"+ "vaadin.themesLoaded['"+ portalTheme+ "'] = true;\n}\n"+ "</script>\n");
        out.write(loadDefaultTheme.getBytes());
      }
      dispatcher.include(request,response);
      if (isLifeRay) {
        OutputStream out=response.getPortletOutputStream();
        String lifeRaySessionHearbeatHack=("<script type=\"text/javascript\">" + "if(!vaadin.postRequestHooks) {" + "    vaadin.postRequestHooks = {};"+ "}"+ "vaadin.postRequestHooks.liferaySessionHeartBeat = function() {"+ "    if (Liferay && Liferay.Session) {"+ "        Liferay.Session.extend();"+ "    }"+ "};"+ "</script>");
        out.write(lifeRaySessionHearbeatHack.getBytes());
      }
    }
 catch (    PortletException e) {
      PrintWriter out=response.getWriter();
      out.print("<h1>Servlet include failed!</h1>");
      out.print("<div>" + e + "</div>");
      ctx.setPortletApplication(this,null);
      return;
    }
    Application app=(Application)request.getAttribute(Application.class.getName());
    ctx.setPortletApplication(this,app);
    ctx.firePortletRenderRequest(this,request,response);
  }
}
