{
  response.setContentType("text/html");
  if (app != null) {
    PortletSession sess=request.getPortletSession();
    PortletApplicationContext ctx=PortletApplicationContext.getApplicationContext(sess);
    PortletRequestDispatcher dispatcher=sess.getPortletContext().getRequestDispatcher("/" + app);
    try {
      PortalContext portalCtx=request.getPortalContext();
      boolean isLifeRay=portalCtx.getPortalInfo().toLowerCase().contains("liferay");
      request.setAttribute(ApplicationServlet.REQUEST_FRAGMENT,"true");
      String portalTheme=getPortalProperty(PORTAL_PARAMETER_VAADIN_THEME,portalCtx);
      String portalWidgetset=getPortalProperty(PORTAL_PARAMETER_VAADIN_WIDGETSET,portalCtx);
      if (portalWidgetset != null) {
        String portalWidgetsetPath=getPortalProperty(PORTAL_PARAMETER_VAADIN_WIDGETSET_PATH,portalCtx);
        if (isLifeRay && portalWidgetsetPath == null) {
          portalWidgetsetPath="/html";
        }
        if (portalWidgetsetPath != null) {
          request.setAttribute(ApplicationServlet.REQUEST_VAADIN_WIDGETSET_PATH,portalWidgetsetPath);
        }
        request.setAttribute(ApplicationServlet.REQUEST_WIDGETSET,portalWidgetset);
      }
 else       if (portletWidgetset != null) {
        request.setAttribute(ApplicationServlet.REQUEST_WIDGETSET,portletWidgetset);
      }
      if (style != null) {
        request.setAttribute(ApplicationServlet.REQUEST_APPSTYLE,style);
      }
      dispatcher.include(request,response);
      if (isLifeRay) {
        OutputStream out=response.getPortletOutputStream();
        String lifeRaySessionHearbeatHack=("<script type=\"text/javascript\">" + "if(!vaadin.postRequestHooks) {" + "    vaadin.postRequestHooks = {};"+ "}"+ "vaadin.postRequestHooks.liferaySessionHeartBeat = function() {"+ "    if (Liferay && Liferay.Session) {"+ "        Liferay.Session.setCookie();"+ "    }"+ "};"+ "</script>");
        out.write(lifeRaySessionHearbeatHack.getBytes());
      }
    }
 catch (    PortletException e) {
      PrintWriter out=response.getWriter();
      out.print("<h1>Servlet include failed!</h1>");
      out.print("<div>" + e + "</div>");
      ctx.setPortletApplication(this,null);
      return;
    }
    Application app=(Application)request.getAttribute(Application.class.getName());
    ctx.setPortletApplication(this,app);
    ctx.firePortletRenderRequest(this,request,response);
  }
}
