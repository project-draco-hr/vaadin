{
  if (handlerRegistration != null) {
    handlerRegistration.removeHandler();
    handlerRegistration=null;
  }
  boolean sendTransferableToServer=false;
  if (currentDropHandler != null) {
    if (doDrop) {
      sendTransferableToServer=currentDropHandler.drop(currentDrag);
      if (sendTransferableToServer) {
        doRequest(DragEventType.DROP);
        final ComponentConnector dragSource=currentDrag.getTransferable().getDragSource();
        final ApplicationConnection client=currentDropHandler.getApplicationConnection();
        Scheduler.get().scheduleFixedDelay(new RepeatingCommand(){
          @Override public boolean execute(){
            if (!client.hasActiveRequest()) {
              removeActiveDragSourceStyleName(dragSource);
              return false;
            }
            return true;
          }
        }
,30);
      }
    }
 else {
      currentDrag.setCurrentGwtEvent(null);
      currentDropHandler.dragLeave(currentDrag);
    }
    currentDropHandler=null;
    serverCallback=null;
    visitId=0;
  }
  if (!sendTransferableToServer && currentDrag != null) {
    removeActiveDragSourceStyleName(currentDrag.getTransferable().getDragSource());
  }
  currentDrag=null;
  clearDragElement();
  Event.releaseCapture(RootPanel.getBodyElement());
}
