{
  RequestCallback requestCallback=new RequestCallback(){
    @Override public void onError(    Request request,    Throwable exception){
      handleError(exception.getMessage(),-1);
    }
    private void handleError(    String details,    int statusCode){
      handleCommunicationError(details,statusCode);
      endRequest();
      setApplicationRunning(false);
    }
    @Override public void onResponseReceived(    Request request,    Response response){
      getLogger().info("Server visit took " + String.valueOf((new Date()).getTime() - requestStartTime.getTime()) + "ms");
      int statusCode=response.getStatusCode();
      fireEvent(new ConnectionStatusEvent(statusCode));
switch (statusCode) {
case 0:
        if (retry) {
          getLogger().warning("Status code 0, retrying");
          (new Timer(){
            @Override public void run(){
              doUidlRequest(uri,payload,false);
            }
          }
).schedule(100);
        }
 else {
          handleError("Invalid status code 0 (server down?)",statusCode);
        }
      return;
case 401:
    showAuthenticationError("");
  endRequest();
return;
case 503:
String delay=response.getHeader("Retry-After");
if (delay != null) {
getLogger().warning("503, retrying in " + delay + "msec");
(new Timer(){
@Override public void run(){
  doUidlRequest(uri,payload);
}
}
).schedule(Integer.parseInt(delay));
return;
}
}
if ((statusCode / 100) == 4) {
showCommunicationError("UIDL could not be read from server. Check servlets mappings. Error code: " + statusCode,statusCode);
endRequest();
return;
}
 else if ((statusCode / 100) == 5) {
handleError("Server error. Error code: " + statusCode,statusCode);
return;
}
String contentType=response.getHeader("Content-Type");
if (contentType == null || !contentType.startsWith("application/json")) {
MatchResult refreshToken=RegExp.compile(UIDL_REFRESH_TOKEN + "(:\\s*(.*?))?(\\s|$)").exec(response.getText());
if (refreshToken != null) {
redirect(refreshToken.getGroup(2));
return;
}
}
final String jsonText=response.getText().substring(9,response.getText().length() - 1);
handleJSONText(jsonText,statusCode);
}
}
;
if (push != null) {
push.push(payload);
}
 else {
try {
doAjaxRequest(uri,payload,requestCallback);
}
 catch (RequestException e) {
getLogger().log(Level.SEVERE,"Error in server request",e);
endRequest();
fireEvent(new ConnectionStatusEvent(0));
}
}
}
