{
  VConsole.log("Starting layout phase");
  Map<ManagedLayout,Integer> layoutCounts=new HashMap<ManagedLayout,Integer>();
  int passes=0;
  Duration totalDuration=new Duration();
  for (  ManagedLayout layout : needsHorizontalLayout) {
    currentDependencyTree.setNeedsHorizontalLayout(layout,true);
  }
  for (  ManagedLayout layout : needsVerticalLayout) {
    currentDependencyTree.setNeedsVerticalLayout(layout,true);
  }
  needsHorizontalLayout.clear();
  needsVerticalLayout.clear();
  for (  ComponentConnector connector : needsMeasure) {
    currentDependencyTree.setNeedsMeasure(connector,true);
  }
  needsMeasure.clear();
  measureNonConnectors();
  VConsole.log("Layout init in " + totalDuration.elapsedMillis() + " ms");
  while (true) {
    Duration passDuration=new Duration();
    passes++;
    int measuredConnectorCount=measureConnectors(currentDependencyTree,everythingNeedsMeasure);
    everythingNeedsMeasure=false;
    if (measuredConnectorCount == 0) {
      VConsole.log("No more changes in pass " + passes);
      break;
    }
    int measureTime=passDuration.elapsedMillis();
    VConsole.log("  Measured " + measuredConnectorCount + " elements in "+ measureTime+ " ms");
    if (!listenersToFire.isEmpty()) {
      for (      Element element : listenersToFire) {
        Collection<ElementResizeListener> listeners=elementResizeListeners.get(element);
        ElementResizeListener[] array=listeners.toArray(new ElementResizeListener[listeners.size()]);
        ElementResizeEvent event=new ElementResizeEvent(this,element);
        for (        ElementResizeListener listener : array) {
          listener.onElementResize(event);
        }
      }
      int measureListenerTime=passDuration.elapsedMillis();
      VConsole.log("  Fired resize listeners for  " + listenersToFire.size() + " elements in "+ (measureListenerTime - measureTime)+ " ms");
      measureTime=measuredConnectorCount;
      listenersToFire.clear();
    }
    FastStringSet updatedSet=FastStringSet.create();
    while (currentDependencyTree.hasHorizontalConnectorToLayout() || currentDependencyTree.hasVerticaConnectorToLayout()) {
      for (      ManagedLayout layout : currentDependencyTree.getHorizontalLayoutTargets()) {
        if (layout instanceof DirectionalManagedLayout) {
          currentDependencyTree.markAsHorizontallyLayouted(layout);
          DirectionalManagedLayout cl=(DirectionalManagedLayout)layout;
          cl.layoutHorizontally();
          countLayout(layoutCounts,cl);
        }
 else {
          currentDependencyTree.markAsHorizontallyLayouted(layout);
          currentDependencyTree.markAsVerticallyLayouted(layout);
          SimpleManagedLayout rr=(SimpleManagedLayout)layout;
          rr.layout();
          countLayout(layoutCounts,rr);
        }
        if (debugLogging) {
          updatedSet.add(layout.getConnectorId());
        }
      }
      for (      ManagedLayout layout : currentDependencyTree.getVerticalLayoutTargets()) {
        if (layout instanceof DirectionalManagedLayout) {
          currentDependencyTree.markAsVerticallyLayouted(layout);
          DirectionalManagedLayout cl=(DirectionalManagedLayout)layout;
          cl.layoutVertically();
          countLayout(layoutCounts,cl);
        }
 else {
          currentDependencyTree.markAsHorizontallyLayouted(layout);
          currentDependencyTree.markAsVerticallyLayouted(layout);
          SimpleManagedLayout rr=(SimpleManagedLayout)layout;
          rr.layout();
          countLayout(layoutCounts,rr);
        }
        if (debugLogging) {
          updatedSet.add(layout.getConnectorId());
        }
      }
    }
    if (debugLogging) {
      JsArrayString changedCids=updatedSet.dump();
      StringBuilder b=new StringBuilder("  ");
      b.append(changedCids.length());
      b.append(" requestLayout invocations in ");
      b.append(passDuration.elapsedMillis() - measureTime);
      b.append(" ms");
      if (changedCids.length() < 30) {
        for (int i=0; i < changedCids.length(); i++) {
          if (i != 0) {
            b.append(", ");
          }
 else {
            b.append(": ");
          }
          String connectorString=changedCids.get(i);
          if (changedCids.length() < 10) {
            ServerConnector connector=ConnectorMap.get(connection).getConnector(connectorString);
            connectorString=Util.getConnectorString(connector);
          }
          b.append(connectorString);
        }
      }
      VConsole.log(b.toString());
    }
    VConsole.log("Pass " + passes + " completed in "+ passDuration.elapsedMillis()+ " ms");
    if (passes > 100) {
      VConsole.log(LOOP_ABORT_MESSAGE);
      VNotification.createNotification(VNotification.DELAY_FOREVER).show(LOOP_ABORT_MESSAGE,VNotification.CENTERED,"error");
      break;
    }
  }
  int postLayoutStart=totalDuration.elapsedMillis();
  for (  ComponentConnector connector : connection.getConnectorMap().getComponentConnectors()) {
    if (connector instanceof PostLayoutListener) {
      ((PostLayoutListener)connector).postLayout();
    }
  }
  VConsole.log("Invoke post layout listeners in " + (totalDuration.elapsedMillis() - postLayoutStart) + " ms");
  VConsole.log("Total layout phase time: " + totalDuration.elapsedMillis() + "ms");
}
