{
  if (!hierarchical) {
    if (noChildrenAllowed == null || parent == null || children == null || roots == null) {
      noChildrenAllowed=new HashSet();
      parent=new Hashtable();
      children=new Hashtable();
      roots=new LinkedList(container.getItemIds());
    }
 else {
      final HashSet s=new HashSet();
      s.add(parent.keySet());
      s.add(children.keySet());
      s.addAll(roots);
      for (final Iterator i=s.iterator(); i.hasNext(); ) {
        final Object id=i.next();
        if (!container.containsId(id)) {
          removeFromHierarchyWrapper(id);
        }
      }
      final Collection ids=container.getItemIds();
      for (final Iterator i=ids.iterator(); i.hasNext(); ) {
        final Object id=i.next();
        if (!s.contains(id)) {
          addToHierarchyWrapper(id);
          s.add(id);
        }
      }
    }
  }
}
