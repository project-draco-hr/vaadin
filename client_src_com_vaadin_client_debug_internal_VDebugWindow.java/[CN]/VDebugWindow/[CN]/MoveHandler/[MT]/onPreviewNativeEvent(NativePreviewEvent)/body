{
  if (event.getTypeInt() == Event.ONMOUSEMOVE && !stop && hasMoved(event.getNativeEvent())) {
    int dx=event.getNativeEvent().getClientX() - startX;
    int dy=event.getNativeEvent().getClientY() - startY;
    setPopupPosition(startLeft + dx,startTop + dy);
    event.cancel();
  }
 else   if (event.getTypeInt() == Event.ONMOUSEUP) {
    stop=true;
    if (hasMoved(event.getNativeEvent())) {
      event.cancel();
    }
  }
 else   if (event.getTypeInt() == Event.ONCLICK) {
    stop=true;
    if (hasMoved(event.getNativeEvent())) {
      event.cancel();
    }
  }
 else   if (stop) {
    stop=false;
    handler.removeHandler();
    handler=null;
    readPositionAndSize();
    writeStoredState();
  }
}
