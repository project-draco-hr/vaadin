{
  final MenuItem item=getSelectedItem();
  final String enteredItemValue=tb.getText();
  if (nullSelectionAllowed && "".equals(enteredItemValue)) {
    if (nullSelectItem) {
      reset();
      return;
    }
    client.updateVariable(paintableId,"filter","",false);
    client.updateVariable(paintableId,"page",0,false);
    client.updateVariable(paintableId,"selected",new String[]{},immediate);
    suggestionPopup.hide();
    return;
  }
  int p=getItems().size();
  if (p > 0) {
    for (int i=0; i < p; i++) {
      final MenuItem potentialExactMatch=(MenuItem)getItems().get(i);
      if (potentialExactMatch.getText().equals(enteredItemValue)) {
        selectItem(potentialExactMatch);
        doItemAction(potentialExactMatch,true);
        suggestionPopup.hide();
        return;
      }
    }
  }
  if (allowNewItem) {
    if (!prompting && !enteredItemValue.equals(lastNewItemString)) {
      lastNewItemString=enteredItemValue;
      client.updateVariable(paintableId,"newitem",enteredItemValue,immediate);
    }
  }
 else   if (item != null && !"".equals(lastFilter) && item.getText().toLowerCase().startsWith(lastFilter.toLowerCase())) {
    doItemAction(item,true);
  }
 else {
    if (currentSuggestion != null) {
      String text=currentSuggestion.getReplacementString();
      selectedOptionKey=currentSuggestion.key;
    }
  }
  suggestionPopup.hide();
}
