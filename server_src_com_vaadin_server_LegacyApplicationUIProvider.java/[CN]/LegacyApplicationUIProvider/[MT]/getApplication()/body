{
  LegacyApplication application=VaadinServiceSession.getCurrent().getAttribute(LegacyApplication.class);
  if (application == null) {
    application=createApplication();
    if (application == null) {
      return null;
    }
    VaadinServiceSession.getCurrent().setAttribute(LegacyApplication.class,application);
    application.doInit();
  }
  if (application != null && !application.isRunning()) {
    VaadinServiceSession.getCurrent().setAttribute(LegacyApplication.class,null);
    return getApplication();
  }
  return application;
}
