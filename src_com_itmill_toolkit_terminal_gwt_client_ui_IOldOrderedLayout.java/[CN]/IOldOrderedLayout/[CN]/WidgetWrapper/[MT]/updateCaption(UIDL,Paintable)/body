{
  final Widget widget=(Widget)paintable;
  final Element captionWrapper=getElementWrappingWidgetAndCaption();
  boolean captionDimensionOrPositionUpdated=false;
  if (ICaption.isNeeded(uidl)) {
    boolean justAdded=false;
    if (caption == null) {
      justAdded=true;
      caption=new ICaption(paintable,client);
    }
    caption.updateCaption(uidl);
    caption.setAlignment(horizontalAlignment);
    int captionHeight=caption.getElement().getOffsetHeight();
    int captionWidth=caption.getElement().getOffsetWidth();
    if (captionHeight != captionSize.getHeight() || captionWidth != captionSize.getWidth()) {
      captionSize=new Size(captionWidth,captionHeight);
      captionDimensionOrPositionUpdated=true;
    }
    final boolean after=caption.shouldBePlacedAfterComponent();
    final Element captionElement=caption.getElement();
    final Element widgetElement=widget.getElement();
    if (justAdded) {
      if (after) {
        DOM.appendChild(captionWrapper,captionElement);
        DOM.setElementAttribute(captionWrapper,"class","i-orderedlayout-w");
        caption.addStyleName("i-orderedlayout-c");
        widget.addStyleName("i-orderedlayout-w-e");
      }
 else {
        DOM.insertChild(captionWrapper,captionElement,0);
      }
      captionDimensionOrPositionUpdated=true;
    }
 else     if (after == (DOM.getChildIndex(captionWrapper,widgetElement) > DOM.getChildIndex(captionWrapper,captionElement))) {
      Element firstElement=DOM.getChild(captionWrapper,DOM.getChildCount(captionWrapper) - 2);
      if (firstElement != null) {
        DOM.removeChild(captionWrapper,firstElement);
        DOM.appendChild(captionWrapper,firstElement);
      }
      DOM.setElementAttribute(captionWrapper,"class",after ? "i-orderedlayout-w" : "");
      if (after) {
        caption.addStyleName("i-orderedlayout-c");
        widget.addStyleName("i-orderedlayout-w-e");
      }
 else {
        widget.removeStyleName("i-orderedlayout-w-e");
        caption.removeStyleName("i-orderedlayout-w-c");
      }
      captionDimensionOrPositionUpdated=true;
    }
 else {
      if (after) {
        widget.addStyleName("i-orderedlayout-w-e");
      }
 else {
        widget.removeStyleName("i-orderedlayout-w-e");
      }
    }
  }
 else {
    if (caption != null) {
      DOM.removeChild(captionWrapper,caption.getElement());
      caption=null;
      DOM.setElementAttribute(captionWrapper,"class","");
      widget.removeStyleName("i-orderedlayout-w-e");
      captionDimensionOrPositionUpdated=true;
    }
  }
  if (captionDimensionOrPositionUpdated) {
    client.handleComponentRelativeSize((Widget)paintable);
  }
}
