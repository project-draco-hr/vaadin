{
  if (node instanceof RuleNode) {
    LexicalUnit value=((RuleNode)node).getValue();
    updateValue(value,variables);
  }
 else {
    Set<Node> toBeDeleted=new HashSet<Node>();
    for (    Node child : node.getChildren()) {
      if (child instanceof VariableNode) {
        variables.put(((VariableNode)child).getName(),(LexicalUnitImpl)((VariableNode)child).getExpr());
        toBeDeleted.add(child);
      }
 else {
        traverse(child,new HashMap<String,LexicalUnitImpl>(variables));
      }
    }
    for (    Node child : toBeDeleted) {
      node.removeChild(child);
    }
  }
}
